<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tambah Produk â€” Dashboard Admin</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    html, body {
      font-family: system-ui, sans-serif;
      background: #f8f9fa;
      margin: 0;
      height: 100%;
    }
    .navbar-brand { color: #212529 !important; }

    .btn-primary {
      background-color: #8B004B;
      border-color: #8B004B;
    }
    .btn-primary:hover {
      background-color: #ad1457;
      border-color: #ad1457;
    }
    .btn-outline-primary {
      border-color: #8B004B;
      color: #8B004B;
    }
    .btn-outline-primary:hover {
      background-color: #8B004B;
      color: #fff;
    }
    .hero {
      background: linear-gradient(to right, #8B004B, #ad1457);
      color: #fff;
      padding: 2rem 1rem;
      text-align: center;
    }
    .content { padding: 2rem 0; }
    .form-container { max-width: 900px; margin: 0 auto; }
    .preview-box {
      border: 1px dashed #ccc;
      border-radius: .5rem;
      background: #fff;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .preview-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .size-row .btn { flex-shrink: 0; }
    @media (max-width: 991px) {
      .content { padding: 1rem 0; }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="dashboardadmin.html">Toko Baju Sahabat</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#adminNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="adminNav">
      <div class="d-flex align-items-center ms-auto" style="gap:.5rem;">
        <button id="logout" class="btn btn-outline-primary btn-sm">Logout</button>
      </div>
    </div>
  </div>
</nav>

<section class="hero">
  <h1>Tambah Produk Baru</h1>
  <p>Masukkan data lengkap produk dan lihat preview gambarnya</p>
</section>

<div class="content container form-container">
  <div class="row g-4">
    <!-- Form -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <form id="addProductForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="nama" class="form-label">Nama Produk</label>
              <input type="text" id="nama" name="nama" class="form-control" required />
            </div>
            <div class="mb-3">
              <label for="harga" class="form-label">Harga</label>
              <input type="text" id="harga" name="harga" class="form-control" placeholder="Rp 0" required />
            </div>
            <div class="mb-3">
              <label for="kategori" class="form-label">Kategori</label>
              <select id="kategori" name="kategori" class="form-select" required>
                <option value="">-- Pilih Kategori --</option>
                <option value="Baju Wanita">Baju Wanita</option>
                <option value="Baju Pria">Baju Pria</option>
                <option value="Baju Anak-anak">Baju Anak-anak</option>
                <option value="Busana Muslim">Busana Muslim</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="subKategori" class="form-label">Sub-Kategori</label>
              <select id="subKategori" name="subKategori" class="form-select" disabled>
                <option value="">-- Pilih Sub-Kategori --</option>
                <option value="Dress">Dress</option>
                <option value="Blouse">Blouse</option>
                <option value="Tunik">Tunik</option>
                <option value="Gamis">Gamis</option>
                <option value="Rok & Celana">Rok & Celana</option>
              </select>
              <div class="form-text">Hanya untuk kategori Baju Wanita</div>
            </div>
            <div class="mb-3">
              <label for="statusProduk" class="form-label">Status Produk</label>
              <select id="statusProduk" name="statusProduk" class="form-select">
                <option value="">(Tidak ada)</option>
                <option value="Barang Baru">Barang Baru</option>
                <option value="Barang Populer">Barang Populer</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="deskripsi" class="form-label">Deskripsi</label>
              <textarea id="deskripsi" name="deskripsi" class="form-control" rows="3"></textarea>
            </div>
            <div class="mb-3">
              <label for="berat" class="form-label">Berat (gram)</label>
              <input type="number" id="berat" name="berat" class="form-control" min="0" required />
            </div>

            <!-- Ukuran & Stok -->
            <div class="mb-3">
              <label class="form-label">Ukuran & Jumlah Stok</label>
              <div id="sizeStockContainer"></div>
              <button type="button" id="addSizeBtn" class="btn btn-outline-primary btn-sm mt-2">
                <i class="bi bi-plus-lg"></i> Tambah Ukuran
              </button>
            </div>

            <div class="mb-3">
              <label for="gambar" class="form-label">Gambar Produk (JPEG/PNG)</label>
              <input type="file" id="gambar" name="gambar" class="form-control" accept="image/*" required />
            </div>
            <button type="submit" class="btn btn-primary">Simpan Produk</button>
            <a href="stok.html" class="btn btn-secondary ms-2">Batal</a>
            <div id="message" class="mt-3"></div>
          </form>
        </div>
      </div>
    </div>
    <!-- Preview -->
    <div class="col-md-6">
      <div class="preview-box" id="previewBox">
        <span>Preview Gambar</span>
      </div>
    </div>
  </div>
</div>

<script>
  // Logout
  document.getElementById('logout').onclick = () => {
    localStorage.removeItem('adminToken');
    window.location.href = 'loginadmin.html';
  };

  // Enable/disable Sub-Kategori
  document.getElementById('kategori').addEventListener('change', function() {
    const sub = document.getElementById('subKategori');
    if (this.value === 'Baju Wanita') sub.disabled = false;
    else { sub.disabled = true; sub.value = ''; }
  });

  // Preview gambar
  document.getElementById('gambar').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const box = document.getElementById('previewBox');
    box.innerHTML = '';
    if (!file) {
      box.innerHTML = '<span>Preview Gambar</span>';
      return;
    }
    const reader = new FileReader();
    reader.onload = evt => {
      const img = document.createElement('img');
      img.src = evt.target.result;
      box.appendChild(img);
    };
    reader.readAsDataURL(file);
  });

  // Format input Rupiah
  const hargaInput = document.getElementById('harga');
  hargaInput.addEventListener('input', e => {
    let val = e.target.value.replace(/[^\d]/g, '');
    if (!val) { e.target.value = ''; return; }
    e.target.value = new Intl.NumberFormat('id-ID', {
      style: 'currency', currency: 'IDR', minimumFractionDigits: 0
    }).format(val);
  });

  // Tambah baris ukuran
  document.getElementById('addSizeBtn').addEventListener('click', () => {
    const container = document.getElementById('sizeStockContainer');
    const row = document.createElement('div');
    row.className = 'd-flex mb-2 size-row';
    row.innerHTML = `
      <input type="text" class="form-control size-input me-2" placeholder="Ukuran" required />
      <input type="number" class="form-control stock-input me-2" placeholder="Stok" min="0" required />
      <button type="button" class="btn btn-outline-danger remove-size-btn"><i class="bi bi-x-lg"></i></button>
    `;
    container.appendChild(row);
    row.querySelector('.remove-size-btn').onclick = () => row.remove();
  });

  // Submit form
  document.getElementById('addProductForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const data = new FormData(form);

    // Strip formatting harga
    const rawHarga = hargaInput.value.replace(/[^\d]/g, '');
    data.set('harga', rawHarga);

    // Kumpulkan ukuran & stok
    const stokObj = {};
    document.querySelectorAll('.size-row').forEach(row => {
      const uk = row.querySelector('.size-input').value.trim();
      const cnt = parseInt(row.querySelector('.stock-input').value) || 0;
      if (uk) stokObj[uk] = cnt;
    });
    data.append('stok', JSON.stringify(stokObj));

    const token = localStorage.getItem('adminToken');
    try {
      const res = await fetch('/api/produk/tambah-produk', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: data
      });
      const result = await res.json();
      const msg = document.getElementById('message');
      if (res.ok) {
        msg.innerHTML = '<div class="alert alert-success">Produk berhasil ditambahkan!</div>';
        form.reset();
        hargaInput.value = '';
        document.getElementById('previewBox').innerHTML = '<span>Preview Gambar</span>';
        document.getElementById('subKategori').disabled = true;
        document.getElementById('sizeStockContainer').innerHTML = '';
      } else {
        msg.innerHTML = `<div class="alert alert-danger">${result.message||'Gagal menambah produk'}</div>`;
      }
    } catch (err) {
      document.getElementById('message').innerHTML =
        '<div class="alert alert-danger">Terjadi kesalahan server.</div>';
      console.error(err);
    }
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
