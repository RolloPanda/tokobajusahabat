<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pembelian (Barang Masuk) — Dashboard Admin</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    html, body { font-family: system-ui, sans-serif; background: #f8f9fa; height: 100%; }
    .navbar .btn-outline-primary { border-color: #8B004B; color: #8B004B; }
    .navbar .btn-outline-primary:hover { background-color: #8B004B; color: #fff; }
    .hero { background: linear-gradient(to right, #8B004B, #ad1457); color:#fff; padding:2rem 1rem; text-align:center; }
    .sidebar { background:#fff; border-right:1px solid #e5e5e5; height:calc(100vh - 56px - 64px); padding-top:1rem; }
    .sidebar a { color:#333; display:block; padding:.75rem 1.5rem; text-decoration:none; }
    .sidebar a.active, .sidebar a:hover { background:#f1f1f1; color:#8B004B; }
    .content { padding:2rem; }
    .table-responsive { margin-top:1rem; background:#fff; border-radius:.5rem; box-shadow:0 .25rem .5rem rgba(0,0,0,0.1); }
    .table-responsive table { table-layout: fixed; width:100%; }
    .table-responsive th, .table-responsive td {
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle;
    }
    th { cursor:pointer; user-select:none; }
    th .sort-icon { font-size:.8rem; margin-left:.3rem; }
    .table-danger { background:#f8d7da !important; }
    .pagination { justify-content:center; }
    .toast-container { position:fixed; bottom:1rem; right:1rem; z-index:1055; }
    .form-section { background:#fff; border-radius:.5rem; box-shadow:0 .25rem .5rem rgba(0,0,0,0.08); padding:1.5rem 1.5rem 1rem 1.5rem; margin-bottom:2rem;}
    .form-label { font-weight: 500; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="dashboardadmin.html">Toko Baju Sahabat</a>
      <div class="d-flex align-items-center ms-auto" style="gap:.5rem;">
        <button id="logout" class="btn btn-outline-primary btn-sm">Logout</button>
      </div>
    </div>
  </nav>
  <!-- Hero -->
  <section class="hero">
    <h1>Pembelian (Barang Masuk)</h1>
    <p>Catat transaksi stok masuk dan riwayat pembelian</p>
  </section>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 sidebar d-none d-md-block">
  <a href="dashboardadmin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="produkadmin.html" class="active"><i class="bi bi-tags me-2"></i>Kelola Produk</a>
  <a href="stok.html"><i class="bi bi-box-seam me-2"></i>Manajemen Stok</a>
  <a href="pembelian.html"><i class="bi bi-download me-2"></i>Pembelian (Barang Masuk)</a>
  <a href="penjualan.html"><i class="bi bi-upload me-2"></i>Penjualan (Barang Keluar)</a>
  <a href="offline.html"><i class="bi bi-shop me-2"></i>Penjualan Offline</a>
  <a href="kelolapesanan.html"><i class="bi bi-inboxes me-2"></i>Kelola Pesanan Online</a>
  <a href="laporan.html"><i class="bi bi-file-earmark-bar-graph me-2"></i>Laporan Stok</a>
  <!-- ✅ Menu baru ditambahkan di sini -->
  <a href="laporanpenjualan.html"><i class="bi bi-journal-text me-2"></i>Laporan Penjualan</a>
  <a href="grafik.html"><i class="bi bi-bar-chart me-2"></i>Grafik</a>
  <a href="pengaturan.html"><i class="bi bi-gear me-2"></i>Pengaturan Admin</a>
</nav>
      <!-- Main Content -->
      <main class="col-md-10 content">
        <!-- FORM PEMBELIAN -->
        <div class="form-section mb-4">
          <h5 class="mb-3"><i class="bi bi-cart-plus me-2"></i>Form Barang Masuk</h5>
          <form id="formPembelian" class="row g-3">
            <div class="col-md-4">
              <label for="produkSelect" class="form-label">Nama Produk</label>
              <select id="produkSelect" name="produk" class="form-select" required>
                <option value="">Pilih produk...</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="ukuranSelect" class="form-label">Ukuran</label>
              <select id="ukuranSelect" name="ukuran" class="form-select" required>
                <option value="">Pilih ukuran...</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="jumlahInput" class="form-label">Jumlah Masuk</label>
              <input type="number" class="form-control" id="jumlahInput" name="jumlah" min="1" required>
            </div>
            <div class="col-md-2">
              <label for="hargaBeliInput" class="form-label">Harga Beli/satuan</label>
              <input type="text" class="form-control" id="hargaBeliInput" name="hargaBeli" required placeholder="Rp 0">
            </div>
            <div class="col-md-2">
              <label for="tanggalInput" class="form-label">Tanggal</label>
              <input type="date" class="form-control" id="tanggalInput" name="tanggal" required>
            </div>
            <div class="col-md-2">
              <label for="supplierInput" class="form-label">Supplier</label>
              <input type="text" class="form-control" id="supplierInput" name="supplier" maxlength="50">
            </div>
            <div class="col-md-12">
              <label for="catatanInput" class="form-label">Catatan</label>
              <input type="text" class="form-control" id="catatanInput" name="catatan" maxlength="100">
            </div>
            <div class="col-12 d-flex gap-2 mt-2">
              <button type="submit" class="btn btn-success"><i class="bi bi-plus-circle"></i> Simpan</button>
              <button type="reset" class="btn btn-secondary">Reset</button>
            </div>
          </form>
        </div>
        <!-- TABEL RIWAYAT PEMBELIAN -->
        <div class="table-responsive">
          <table class="table table-striped mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th>Gambar</th>
                <th>Nama Produk</th>
                <th>Kategori</th>
                <th>Jumlah Masuk</th>
                <th>Ukuran</th>
                <th>Harga Beli/satuan</th>
                <th>Total Belanja</th>
                <th>Tanggal</th>
                <th>Supplier</th>
                <th>Catatan</th>
              </tr>
            </thead>
            <tbody id="pembelianTbody"></tbody>
          </table>
        </div>
        <!-- Pagination (optional) -->
        <nav class="mt-3"><ul class="pagination"></ul></nav>
      </main>
    </div>
  </div>
  <!-- Toast Notifikasi -->
  <div class="toast-container">
    <div id="notifToast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="notifToastMsg"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Format angka ke rupiah
    function formatRupiah(num) {
      if (typeof num !== 'number') num = parseInt(num) || 0;
      return 'Rp ' + num.toLocaleString('id-ID');
    }
    function formatRupiahInput(angka) {
      angka = angka.replace(/[^0-9]/g, '');
      if (!angka) return '';
      return 'Rp ' + angka.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    // Listener untuk input harga beli
    const hargaBeliInput = document.getElementById('hargaBeliInput');
    hargaBeliInput.addEventListener('input', function () {
      const cursor = this.selectionStart;
      this.value = formatRupiahInput(this.value);
      this.setSelectionRange(cursor, cursor);
    });

    // Notifikasi toast helper
    function showNotif(msg, type='success') {
      const notif = document.getElementById('notifToast');
      const notifMsg = document.getElementById('notifToastMsg');
      notifMsg.textContent = msg;
      notif.classList.remove('bg-success','bg-danger','bg-warning');
      notif.classList.add('bg-' + type);
      new bootstrap.Toast(notif).show();
    }
    // Set default tanggal hari ini
    document.getElementById('tanggalInput').valueAsDate = new Date();

    // DATA GLOBAL
    let produkList = [], pembelianData = [];

    // ASYNC LOAD (Paralel & Fast)
    async function loadAllData() {
      const [produkRes, pembelianRes] = await Promise.all([
        fetch('/api/produk'),
        fetch('/api/pembelian')
      ]);
      produkList = await produkRes.json();
      pembelianData = await pembelianRes.json();
      renderProdukSelect();
      renderPembelian();
    }
    // Render select produk
    function renderProdukSelect() {
      const select = document.getElementById('produkSelect');
      select.innerHTML = '<option value="">Pilih produk...</option>' +
        produkList.map(p => `<option value="${p._id}">${p.nama}</option>`).join('');
      // Trigger ukuran update ketika produk diganti
      select.onchange = renderUkuranSelect;
    }

    // Render select ukuran dari stok Map produk terpilih
    function renderUkuranSelect() {
      const produkId = document.getElementById('produkSelect').value;
      const produk = produkList.find(p => p._id === produkId);
      const ukuranSelect = document.getElementById('ukuranSelect');
      if (!produk || !produk.stok || Object.keys(produk.stok).length === 0) {
        ukuranSelect.innerHTML = '<option value="">-</option>';
        ukuranSelect.disabled = true;
      } else {
        ukuranSelect.innerHTML =
          '<option value="">Pilih ukuran...</option>' +
          Object.keys(produk.stok).map(u => `<option value="${u}">${u.toUpperCase()}</option>`).join('');
        ukuranSelect.disabled = false;
      }
    }

    // Render tabel pembelian
    function renderPembelian() {
      const tbody = document.getElementById('pembelianTbody');
      tbody.innerHTML = pembelianData.map((trx) => {
        const p = produkList.find(x=>x._id===trx.produkId || (x._id === (trx.produkId?._id))) || trx.produkId || {};
        const total = typeof trx.totalBelanja === 'number'
          ? trx.totalBelanja
          : (trx.jumlah * trx.hargaBeli);
        return `<tr>
          <td><img src="/api/produk/gambar/${p._id||''}" style="max-width:40px;"/></td>
          <td>${p.nama||'-'}</td>
          <td>${p.kategori||'-'}</td>
          <td>${trx.jumlah}</td>
          <td>${trx.ukuran ? trx.ukuran.toUpperCase() : '-'}</td>
          <td>${formatRupiah(trx.hargaBeli)}</td>
          <td>${formatRupiah(total)}</td>
          <td>${trx.tanggal ? trx.tanggal.substr(0,10) : '-'}</td>
          <td>${trx.supplier||'-'}</td>
          <td>${trx.catatan||'-'}</td>
        </tr>`;
      }).join('');
    }

    // Form submit handler
    document.getElementById('formPembelian').onsubmit = async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);

      // Ambil angka asli harga beli dari input
      let hargaBeliValue = fd.get('hargaBeli').replace(/[^0-9]/g, '');
      hargaBeliValue = parseInt(hargaBeliValue) || 0;

      const payload = {
        produkId: fd.get('produk'),
        ukuran: fd.get('ukuran'),
        jumlah: parseInt(fd.get('jumlah')),
        hargaBeli: hargaBeliValue,
        tanggal: fd.get('tanggal'),
        supplier: fd.get('supplier'),
        catatan: fd.get('catatan')
      };
      if(!payload.produkId || !payload.ukuran || !payload.jumlah || !payload.hargaBeli || !payload.tanggal) {
        showNotif('Isi data pembelian dengan lengkap','warning');
        return;
      }
      const res = await fetch('/api/pembelian', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      if(res.ok){
        showNotif('Pembelian/barang masuk berhasil dicatat!');
        e.target.reset();
        document.getElementById('tanggalInput').valueAsDate = new Date();
        pembelianData = await (await fetch('/api/pembelian')).json();
        renderPembelian();
      }else{
        const err = await res.json();
        showNotif(err.message||'Gagal simpan pembelian','danger');
      }
    };

    // Logout handler
    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('adminToken');
      window.location.href = 'masukadmin.html';
    };

    // Initial load
    loadAllData();
  </script>
</body>
</html>
