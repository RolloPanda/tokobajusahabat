<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Penjualan â€” Dashboard Admin</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    html, body { font-family: system-ui, sans-serif; background:#f8f9fa; height:100%; }
    .sidebar { background:#fff; border-right:1px solid #e5e5e5; height:calc(100vh - 56px - 80px); padding-top:1rem; }
    .sidebar a { color:#333; display:block; padding:.75rem 1.5rem; text-decoration:none; }
    .sidebar a.active, .sidebar a:hover { background:#f1f1f1; color:#8B004B; }
    .content { padding:2rem; }
    .hero { background:linear-gradient(90deg,#8B004B,#ad1457); color:#fff; padding:2.5rem 1rem; text-align:center; }
    .hero h1 { margin-bottom:.5rem; }
    .filter-card { background:#fff; border-radius:.75rem; padding:1rem 1.25rem; box-shadow:0 2px 6px rgba(0,0,0,.05); margin-bottom:1.5rem; }
    .summary-cards { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:2rem; }
    .summary-card { flex:1; background:#fff; border-radius:.75rem; padding:1rem; text-align:center; box-shadow:0 2px 6px rgba(0,0,0,.08); }
    .summary-card h5 { font-size:1rem; margin-bottom:.25rem; color:#666; }
    .summary-card h2 { color:#8B004B; font-weight:700; font-size:1.4rem; }
    table { font-size:.92rem; }
    .table thead { background:#fafafa; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="dashboardadmin.html">Toko Baju Sahabat</a>
      <div class="d-flex align-items-center ms-auto" style="gap:.5rem;">
        <button id="logout" class="btn btn-outline-primary btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <h1>Laporan Penjualan</h1>
    <p>Rekapitulasi penjualan online & offline dalam periode tertentu</p>
  </section>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 sidebar d-none d-md-block">
        <a href="dashboardadmin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
        <a href="produkadmin.html"><i class="bi bi-tags me-2"></i>Kelola Produk</a>
        <a href="stok.html"><i class="bi bi-box-seam me-2"></i>Manajemen Stok</a>
        <a href="pembelian.html"><i class="bi bi-download me-2"></i>Pembelian (Barang Masuk)</a>
        <a href="penjualan.html"><i class="bi bi-upload me-2"></i>Penjualan (Barang Keluar)</a>
        <a href="offline.html"><i class="bi bi-shop me-2"></i>Penjualan Offline</a>
        <a href="kelolapesanan.html"><i class="bi bi-inboxes me-2"></i>Kelola Pesanan Online</a>
        <a href="laporan.html"><i class="bi bi-file-earmark-bar-graph me-2"></i>Laporan Stok</a>
        <a href="laporanpenjualan.html" class="active"><i class="bi bi-journal-text me-2"></i>Laporan Penjualan</a>
        <a href="grafik.html"><i class="bi bi-bar-chart me-2"></i>Grafik</a>
        <a href="pengaturan.html"><i class="bi bi-gear me-2"></i>Pengaturan Admin</a>
      </nav>

      <!-- Main Content -->
      <main class="col-md-10 content">
        <!-- Filter -->
        <div class="filter-card">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <label class="form-label mb-0 me-2">Periode:</label>
            <select id="periodeSelect" class="form-select form-select-sm" style="max-width:200px">
              <option value="hari">Hari Ini</option>
              <option value="bulan">Bulan Ini</option>
              <option value="3bulan">3 Bulan Terakhir</option>
              <option value="6bulan">6 Bulan Terakhir</option>
              <option value="tahun">1 Tahun Terakhir</option>
              <option value="custom">Custom</option>
            </select>
            <div id="customRange" style="display:none" class="d-flex align-items-center gap-2">
              <input type="date" id="filterStart" class="form-control form-control-sm" style="max-width:160px" />
              <span class="mx-1">s/d</span>
              <input type="date" id="filterEnd" class="form-control form-control-sm" style="max-width:160px" />
            </div>
            <button class="btn btn-sm btn-primary" id="filterBtn"><i class="bi bi-check-circle"></i> Terapkan</button>
          </div>
        </div>

        <!-- Summary -->
        <div class="summary-cards">
          <div class="summary-card">
            <h5>Jumlah Online</h5>
            <h2 id="countOnline">0</h2>
          </div>
          <div class="summary-card">
            <h5>Jumlah Offline</h5>
            <h2 id="countOffline">0</h2>
          </div>
          <div class="summary-card">
            <h5>Total Transaksi</h5>
            <h2 id="countTotal">0</h2>
          </div>
          <div class="summary-card">
            <h5>Subtotal Online</h5>
            <h2 id="subtotalOnline">Rp 0</h2>
          </div>
          <div class="summary-card">
            <h5>Subtotal Offline</h5>
            <h2 id="subtotalOffline">Rp 0</h2>
          </div>
          <div class="summary-card">
            <h5>Total Penjualan</h5>
            <h2 id="subtotalTotal">Rp 0</h2>
          </div>
        </div>

        <h4>Detail Penjualan Online</h4>
        <div class="table-responsive mb-4">
          <table class="table table-striped table-bordered table-hover align-middle mb-0" id="penjualanOnlineTable">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Email</th>
                <th>Nama Penerima</th>
                <th>Metode</th>
                <th>Total</th>
                <th>Tanggal</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <h4>Detail Penjualan Offline</h4>
        <div class="table-responsive mb-4">
          <table class="table table-striped table-bordered table-hover align-middle mb-0" id="penjualanOfflineTable">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>Produk</th>
                <th>Jumlah</th>
                <th>Harga</th>
                <th>Total</th>
                <th>Metode</th>
                <th>Tanggal</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Format Rupiah
    function formatRupiah(num){ if(!num) return 'Rp 0'; return 'Rp ' + Number(num).toLocaleString('id-ID'); }

    // Utility ambil tanggal hari ini
    function getTodayLocalDate(){
      const today = new Date();
      const y = today.getFullYear(), m = String(today.getMonth()+1).padStart(2,'0'), d = String(today.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    let filterStart="", filterEnd="";

    function isInDateRange(dateStr){
      if(!dateStr) return false;
      const d=new Date(dateStr);
      if(filterStart){
        const start=new Date(filterStart); start.setHours(0,0,0,0);
        if(d<start) return false;
      }
      if(filterEnd){
        const end=new Date(filterEnd); end.setHours(23,59,59,999);
        if(d>end) return false;
      }
      return true;
    }

    async function loadPenjualanOnline(){
      const res=await fetch('/api/admin/pembayarans?status=Diproses,Dikirim,Diterima,Selesai&limit=1000',
        {headers:{'Authorization':'Bearer '+(localStorage.getItem('adminToken')||'')}});
      const data=await res.json();
      const arr=data.data||data;
      const tbody=document.querySelector('#penjualanOnlineTable tbody');
      tbody.innerHTML='';
      let subtotal=0,count=0,no=1;
      arr.forEach(row=>{
        if(!isInDateRange(row.tanggal)) return;
        subtotal+=row.total||0; count++;
        tbody.innerHTML+=`<tr>
          <td>${no++}</td><td>${row.email||'-'}</td>
          <td>${row.namaPenerima||'-'}</td>
          <td>${row.metode||'-'}</td>
          <td>${formatRupiah(row.total)}</td>
          <td>${row.tanggal?new Date(row.tanggal).toLocaleString('id-ID'):'-'}</td>
        </tr>`;
      });
      document.getElementById('subtotalOnline').textContent=formatRupiah(subtotal);
      document.getElementById('countOnline').textContent=count;
      return {subtotal,count};
    }

    async function loadPenjualanOffline(){
      const res=await fetch('/api/admin/pembayaranoffline/riwayat');
      const data=await res.json();
      const tbody=document.querySelector('#penjualanOfflineTable tbody');
      tbody.innerHTML='';
      let subtotal=0,count=0,no=1;
      data.forEach(trx=>{
        if(!isInDateRange(trx.tanggal)) return;
        count++;
        trx.items.forEach(item=>{
          const totalItem=(item.harga||0)*(item.jumlah||0);
          subtotal+=totalItem;
          tbody.innerHTML+=`<tr>
            <td>${no++}</td><td>${item.nama||'-'}</td><td>${item.jumlah||'-'}</td>
            <td>${formatRupiah(item.harga)}</td><td>${formatRupiah(totalItem)}</td>
            <td>${item.metode||'-'}</td>
            <td>${trx.tanggal?new Date(trx.tanggal).toLocaleString('id-ID'):'-'}</td>
          </tr>`;
        });
      });
      document.getElementById('subtotalOffline').textContent=formatRupiah(subtotal);
      document.getElementById('countOffline').textContent=count;
      return {subtotal,count};
    }

    async function loadAll(){
      const online=await loadPenjualanOnline();
      const offline=await loadPenjualanOffline();
      document.getElementById('subtotalTotal').textContent=formatRupiah(online.subtotal+offline.subtotal);
      document.getElementById('countTotal').textContent=online.count+offline.count;
    }

    // Handle filter
    document.getElementById('periodeSelect').onchange=()=>{
      const val=document.getElementById('periodeSelect').value;
      const today=new Date();
      if(val==='hari'){
        const t=getTodayLocalDate(); filterStart=t; filterEnd=t;
      } else if(val==='bulan'){
        filterStart=`${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-01`;
        filterEnd=getTodayLocalDate();
      } else if(val==='3bulan'){
        const past=new Date(); past.setMonth(past.getMonth()-3);
        filterStart=`${past.getFullYear()}-${String(past.getMonth()+1).padStart(2,'0')}-${String(past.getDate()).padStart(2,'0')}`;
        filterEnd=getTodayLocalDate();
      } else if(val==='6bulan'){
        const past=new Date(); past.setMonth(past.getMonth()-6);
        filterStart=`${past.getFullYear()}-${String(past.getMonth()+1).padStart(2,'0')}-${String(past.getDate()).padStart(2,'0')}`;
        filterEnd=getTodayLocalDate();
      } else if(val==='tahun'){
        const past=new Date(); past.setFullYear(past.getFullYear()-1);
        filterStart=`${past.getFullYear()}-${String(past.getMonth()+1).padStart(2,'0')}-${String(past.getDate()).padStart(2,'0')}`;
        filterEnd=getTodayLocalDate();
      } else if(val==='custom'){
        document.getElementById('customRange').style.display='flex';
        return;
      }
      document.getElementById('customRange').style.display='none';
      loadAll();
    };

    document.getElementById('filterBtn').onclick=()=>{
      if(document.getElementById('periodeSelect').value==='custom'){
        filterStart=document.getElementById('filterStart').value;
        filterEnd=document.getElementById('filterEnd').value;
      }
      loadAll();
    };

    // Default hari ini
    document.addEventListener('DOMContentLoaded',()=>{
      const today=getTodayLocalDate();
      filterStart=today; filterEnd=today;
      loadAll();
    });

    // Logout
    document.getElementById('logout').onclick=()=>{
      localStorage.removeItem('adminToken');
      window.location.href='loginadmin.html';
    };
  </script>
</body>
</html>
