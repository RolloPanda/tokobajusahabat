<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Proses Retur Pesanan | Toko Baju Sahabat</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f8f9fa; font-family: system-ui,sans-serif;}
    .btn-toko-outline {
      border-color: #8B004B !important;
      color: #8B004B !important;
      background: transparent;
      transition: background 0.2s, color 0.2s;
    }
    .btn-toko-outline:hover, .btn-toko-outline:focus {
      background-color: #8B004B !important;
      color: #fff !important;
      border-color: #8B004B !important;
    }
    .sidebar { background:#fff; border-right:1px solid #e5e5e5; height:calc(100vh - 56px); padding-top:1rem;}
    .sidebar a { color:#333; display:block; padding:.75rem 1.5rem; text-decoration:none;}
    .sidebar a.active, .sidebar a:hover { background:#f1f1f1; color:#8B004B;}
    .content { padding:2rem 2vw;}
    .main-card { background:#fff; border-radius:15px; box-shadow:0 6px 20px #0001; padding:2.5rem 2.5rem 2rem; margin-bottom:2rem; max-width:900px; margin-left:auto; margin-right:auto;}
    .section-title {color:#8B004B; font-weight:700;}
    .bukti-retur-img {max-width:340px; max-height:320px; border-radius:12px; border:2px solid #f5c2c7; box-shadow:0 1px 8px #e14c6122;}
    .refund-proof-img {max-width:320px; border-radius:12px; border:2px solid #cfe2ff;}
    .table th, .table td {vertical-align:middle;}
    .badge-retur {font-size:.98em; font-weight:600; padding:.35em 1.1em; border-radius:.7em; margin-left:8px;}
    .badge-retur.menunggu {background:#fff3cd; color:#8B7300;}
    .badge-retur.diproses  {background:#e7dfff; color:#6c24b7;}
    .badge-retur.diterima  {background:#d2ffe3; color:#008B2F;}
    .badge-retur.ditolak   {background:#ffe2e2; color:#e14c61;}
    .badge-retur.kosong    {background:#eaeaea; color:#999;}
    @media (max-width: 768px) {
      .main-card {padding:1.2rem;}
      .content {padding:.5rem;}
      .bukti-retur-img, .refund-proof-img {max-width:100%;}
    }
  </style>
  <script>
    const token = localStorage.getItem('adminToken');
    if (!token) {
      alert('Silakan login sebagai admin!');
      window.location.href = 'loginadmin.html';
    }
    function getOrderId() {
      return new URLSearchParams(window.location.search).get('id');
    }
    function tgl(d) { return d ? new Date(d).toLocaleString('id-ID') : '-'; }
    function badgeRetur(st) {
      if (!st) return '<span class="badge-retur kosong">Belum ada pengajuan retur</span>';
      const map = {
        "Menunggu Konfirmasi":"menunggu",
        "Diproses":"diproses",
        "Diterima":"diterima",
        "Ditolak":"ditolak",
        "Selesai":"diterima"
      };
      return `<span class="badge-retur ${map[st]||''}">${st}</span>`;
    }
    function rupiah(v) {
      return (v==null) ? '-' : 'Rp ' + Number(v).toLocaleString('id-ID');
    }
    async function prosesRetur(status) {
      const id = getOrderId();
      const res = await fetch(`/api/admin/pembayarans/${id}/retur`, {
        method: 'PATCH',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status })
      });
      const json = await res.json();
      if (!res.ok) alert(json.message || 'Gagal update status retur');
      else { alert(`Retur berhasil di-${status.toLowerCase()}`); loadDetail(); }
    }
  </script>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="dashboardadmin.html">Toko Baju Sahabat</a>
  </div>
</nav>
<div class="container-fluid">
  <div class="row">
    <nav class="col-md-2 sidebar d-none d-md-block">
  <a href="dashboardadmin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="produkadmin.html" class="active"><i class="bi bi-tags me-2"></i>Kelola Produk</a>
  <a href="stok.html"><i class="bi bi-box-seam me-2"></i>Manajemen Stok</a>
  <a href="pembelian.html"><i class="bi bi-download me-2"></i>Pembelian (Barang Masuk)</a>
  <a href="penjualan.html"><i class="bi bi-upload me-2"></i>Penjualan (Barang Keluar)</a>
  <a href="offline.html"><i class="bi bi-shop me-2"></i>Penjualan Offline</a>
  <a href="kelolapesanan.html"><i class="bi bi-inboxes me-2"></i>Kelola Pesanan Online</a>
  <a href="laporan.html"><i class="bi bi-file-earmark-bar-graph me-2"></i>Laporan Stok</a>
  <!-- âœ… Menu baru ditambahkan di sini -->
  <a href="laporanpenjualan.html"><i class="bi bi-journal-text me-2"></i>Laporan Penjualan</a>
  <a href="grafik.html"><i class="bi bi-bar-chart me-2"></i>Grafik</a>
  <a href="pengaturan.html"><i class="bi bi-gear me-2"></i>Pengaturan Admin</a>
</nav>
    <main class="col-md-10 content">
      <div class="main-card">
        <h2 class="section-title mb-3">Proses Retur Baju</h2>
        <div id="detailContainer"></div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function loadDetail() {
  const id = getOrderId();
  const c  = document.getElementById('detailContainer');
  c.innerHTML = '';
  if (!id) { c.innerText = 'ID pesanan tidak ditemukan.'; return; }

  const resp = await fetch(`/api/admin/pembayarans/${id}`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  if (!resp.ok) { c.innerText = 'Gagal memuat pesanan.'; return; }
  const { success, pesanan:o } = await resp.json();
  if (!success) { c.innerText = 'Gagal memuat pesanan.'; return; }
  const retur = o.retur || {};

  const totalGr = (o.items||[]).reduce((sum,i)=> sum + (i.berat||0)*i.jumlah,0);
  const beratA = (totalGr/1000).toFixed(2)+' kg';
  const beratB = Math.ceil(totalGr/1000)+' kg';
  const alamat = o.detailPesanan?.alamat || '-';
  const kota   = o.detailPesanan?.kota     || '-';
  const prov   = o.detailPesanan?.provinsi || '-';
  const kurir0 = o.detailPesanan?.kurir    || '-';
  const resi0  = o.detailPesanan?.resi     || '-';
  const ongkir0= o.detailPesanan?.ongkir   || 0;

  let tombol = '';
  const st = (retur.status||'').toLowerCase();
  if (!st || st==='menunggu konfirmasi') {
    tombol = `<button class="btn btn-outline-primary btn-sm"
                onclick="prosesRetur('Diproses')">
                <i class="bi bi-gear-fill"></i> Proses Retur
              </button>`;
  } else if (st==='diproses') {
    tombol = `
      <button class="btn btn-outline-success btn-sm me-2"
              onclick="prosesRetur('Diterima')">
        <i class="bi bi-check-circle-fill"></i> Terima Retur
      </button>
      <button class="btn btn-outline-danger btn-sm"
              onclick="prosesRetur('Ditolak')">
        <i class="bi bi-x-circle-fill"></i> Tolak Retur
      </button>`;
  }

  // ----------------- Shipping Retur Section -----------------
  let shipHTML = '';
  let editShipForm = '';
  if (retur.status === 'Diterima' && retur.shipmentAwb) {
    shipHTML = `
      <div class="mb-4">
        <h5>Data Pengiriman Balik oleh Pembeli</h5>
        <p><strong>Kurir:</strong> ${retur.shipmentKurir}</p>
        <p><strong>No. AWB:</strong> ${retur.shipmentAwb}</p>
        <p><strong>Ongkir:</strong> Rp ${retur.shipmentOngkir?.toLocaleString('id-ID')}</p>
      </div>
    `;
    // FORM EDIT ONGKIR (kurir & awb readonly!)
    editShipForm = `
      <div class="card card-body mb-4 border-info">
        <h6 class="mb-2 text-info"><i class="bi bi-pencil-square"></i> Edit Ongkir Pengiriman Balik (Admin)</h6>
        <form id="formEditShipping" class="row g-2">
          <div class="col-md-4">
            <label class="form-label">Kurir</label>
            <input type="text" name="kurir" class="form-control form-control-sm" value="${retur.shipmentKurir||''}" readonly>
          </div>
          <div class="col-md-4">
            <label class="form-label">No. AWB</label>
            <input type="text" name="awb" class="form-control form-control-sm" value="${retur.shipmentAwb||''}" readonly>
          </div>
          <div class="col-md-4">
            <label class="form-label">Ongkir (Rp)</label>
            <input type="number" name="ongkir" class="form-control form-control-sm" value="${retur.shipmentOngkir||''}" required>
          </div>
          <div class="col-12">
            <button class="btn btn-outline-info btn-sm" type="submit">
              <i class="bi bi-save"></i> Simpan Ongkir
            </button>
          </div>
        </form>
      </div>
    `;
  } else if (retur.status === 'Diterima') {
    shipHTML = `<div class="alert alert-info">Menunggu data pengiriman retur dari pembeli.</div>`;
  }

  // ----------------- Form Refund Section (admin) -----------------
  let refundForm = '';
  let refundInfo = '';
  if (retur.status === 'Diterima' && retur.shipmentAwb && !retur.refundAmount) {
    // Nominal refund = o.total + shipmentOngkir (read-only!)
    const refundCalc = Number(o.total||0) + Number(retur.shipmentOngkir||0);
    refundForm = `
      <form id="formRefund" class="card card-body mb-4 border-success">
        <h6 class="mb-2 text-success"><i class="bi bi-cash-stack"></i> Konfirmasi Refund (Admin)</h6>
        <div class="mb-2">
          <label class="form-label">Nominal Refund (otomatis dari sistem)</label>
          <input type="number" class="form-control" name="amount" value="${refundCalc}" readonly>
          <small class="text-muted">Nominal refund = Total Pesanan + Ongkir pengiriman balik</small>
        </div>
        <div class="mb-2">
          <label class="form-label">Upload Bukti Transfer Refund (jpg/png/pdf)</label>
          <input type="file" name="bukti" class="form-control" accept="image/*,.pdf" required>
        </div>
        <button class="btn btn-success" type="submit">
          <i class="bi bi-check2-square"></i> Simpan & Selesaikan Retur
        </button>
      </form>
    `;
  } else if (retur.refundAmount) {
    refundInfo = `
      <div class="alert alert-success">
        <strong>Refund telah diproses:</strong><br>
        Jumlah Refund: <b>${rupiah(retur.refundAmount)}</b><br>
        Waktu Refund: ${tgl(retur.refundAt)}
        ${retur.refundProof?.data
          ? `<div class="mt-2">
              <a href="/api/admin/pembayarans/${o._id}/retur/refund/bukti" target="_blank">
                <img src="/api/admin/pembayarans/${o._id}/retur/refund/bukti" class="refund-proof-img mt-2" alt="Bukti Refund" onerror="this.style.display='none'"/>
                <br><span class="badge bg-info">Lihat Bukti Transfer Refund</span>
              </a>
            </div>`
          : ''}
      </div>
    `;
  }

  c.innerHTML = `
    <div class="row">
      <div class="col-lg-6 mb-4">
        <div class="mb-2"><strong>ID Pesanan:</strong> ${o._id}</div>
        <div class="mb-2"><strong>Tanggal Order:</strong> ${tgl(o.tanggal)}</div>
        <div class="mb-2"><strong>Status:</strong> <span class="badge bg-secondary">${o.status}</span></div>
        <div class="mb-2"><strong>Email:</strong> ${o.email}</div>
        <div class="mb-2"><strong>Penerima:</strong> ${o.namaPenerima||'-'}</div>
        <div class="mb-2"><strong>Telepon:</strong> ${o.phone||'-'}</div>
        <div class="mb-2"><strong>Metode:</strong> ${o.metode}</div>
        ${o.metode==='Transfer'
          ? `<div class="mb-2"><strong>Nama Rekening:</strong> ${o.namaRekening||'-'}</div>`
          : ''}
      </div>
      <div class="col-lg-6 mb-4">
        <div class="mb-2"><strong>Alamat:</strong><br>${alamat}<br>${kota}, ${prov}</div>
        <div class="mb-2"><strong>Kurir:</strong> ${kurir0}</div>
        <div class="mb-2"><strong>Resi:</strong> ${resi0}</div>
        <div class="mb-2"><strong>Subtotal:</strong> Rp ${o.subtotal?.toLocaleString('id-ID')||'0'}</div>
        <div class="mb-2"><strong>Ongkir:</strong> Rp ${ongkir0?.toLocaleString('id-ID')||'0'}</div>
        <div class="mb-2"><strong>Total:</strong> <span class="fw-bold">Rp ${o.total?.toLocaleString('id-ID')||'0'}</span></div>
        <div class="mb-2"><strong>Berat Akurat:</strong> ${beratA}</div>
        <div class="mb-2"><strong>Berat Dibulatkan:</strong> ${beratB}</div>
      </div>
    </div>
    <div class="mb-4 mt-2">
      <h5><i class="bi bi-arrow-counterclockwise"></i> Info Retur Baju ${badgeRetur(retur.status)}</h5>
      <div class="mb-2"><strong>Alasan:</strong> ${retur.alasan||'-'}</div>
      <div class="mb-2"><strong>Deskripsi:</strong> ${retur.deskripsi||'-'}</div>
      <div class="mb-2"><strong>Ajukan:</strong> ${tgl(retur.createdAt)}</div>
      <div class="mb-2"><strong>Update:</strong> ${tgl(retur.updatedAt)}</div>
      <div id="buktiReturAdmin"></div>
      <div class="mb-2"><strong>Bank:</strong> ${retur.bank||'-'}</div>
      <div class="mb-2"><strong>Rek:</strong> ${retur.rekening||'-'}</div>
      <div class="mb-2"><strong>Pemilik:</strong> ${retur.pemilik||'-'}</div>
      <div class="mt-3">${tombol}</div>
    </div>
    ${shipHTML}
    ${editShipForm}
    ${refundForm}
    ${refundInfo}
    <div class="mb-4">
      <h5><i class="bi bi-bag"></i> Daftar Produk</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>No</th>
              <th>Nama Produk</th>
              <th>Ukuran</th>
              <th>Jumlah</th>
              <th>Harga</th>
              <th>Total</th>
              <th>Berat/item</th>
              <th>ID Produk</th>
            </tr>
          </thead>
          <tbody>
            ${(retur.items || o.items || []).map((i,idx) => `
              <tr>
                <td>${idx+1}</td>
                <td>${i.nama}</td>
                <td>${i.ukuran || '-'}</td>
                <td>${i.jumlah}</td>
                <td>Rp ${i.harga?.toLocaleString('id-ID') || '0'}</td>
                <td>Rp ${(i.harga * i.jumlah)?.toLocaleString('id-ID') || '0'}</td>
                <td>${i.berat || 0} gr</td>
                <td>${i.produkId || '-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
    <div class="mb-4 text-center" id="buktiReturBlock"></div>
    <div>
      <a href="kelolapesanan.html" class="btn btn-toko-outline">
        <i class="bi bi-inboxes"></i> Kembali ke Kelola Pesanan
      </a>
    </div>
  `;

  // render gambar bukti retur
  const proofEl = document.getElementById('buktiReturAdmin');
  if (proofEl && retur.bukti?.data) {
    proofEl.innerHTML = `
      <div class="mb-3 text-center">
        <b>Foto Bukti Retur:</b><br>
        <img src="/api/admin/pembayarans/${id}/retur/bukti"
             class="bukti-retur-img"
             alt="Bukti Retur"
             onerror="this.outerHTML='<small class=\'text-muted\'>Gagal memuat gambar bukti.</small>'" />
      </div>`;
  }

  // ---------- Handle Form Edit Ongkir Shipping Retur ----------
  const formEdit = document.getElementById("formEditShipping");
  if (formEdit) {
    formEdit.onsubmit = async function(e) {
      e.preventDefault();
      const ongkir = formEdit.ongkir.value.trim();
      if (!ongkir) return alert('Ongkir wajib diisi.');
      const kurir = formEdit.kurir.value.trim();
      const awb   = formEdit.awb.value.trim();
      const res = await fetch(`/api/admin/pembayarans/${id}/retur/shipment`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ kurir, awb, ongkir })
      });
      const j = await res.json();
      if (res.ok) {
        alert('Ongkir berhasil diupdate.');
        loadDetail();
      } else {
        alert(j.message || 'Gagal update ongkir.');
      }
    }
  }

  // ---------- Handle Form Refund ----------
  const formRefund = document.getElementById("formRefund");
  if (formRefund) {
    formRefund.onsubmit = async function(e) {
      e.preventDefault();
      const bukti = formRefund.bukti.files[0];
      if (!bukti) return alert('Bukti transfer refund wajib diupload!');
      const fd = new FormData();
      fd.append('bukti', bukti);

      // Amount tidak dikirim, backend akan hitung otomatis!
      const res = await fetch(`/api/admin/pembayarans/${id}/retur/refund`, {
        method: 'PATCH',
        headers: { 'Authorization': 'Bearer ' + token },
        body: fd
      });
      const j = await res.json();
      if (res.ok) {
        alert('Refund berhasil disimpan & retur selesai!');
        loadDetail();
      } else {
        alert(j.message || 'Gagal simpan refund');
      }
    }
  }
}

document.addEventListener('DOMContentLoaded', loadDetail);
</script>
</body>
</html>
