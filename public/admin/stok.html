<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stok & Manajemen — Dashboard Admin</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    html, body { font-family: system-ui, sans-serif; background: #f8f9fa; margin:0; height:100%; }
    .navbar .btn-outline-primary { border-color: #8B004B; color: #8B004B; }
    .navbar .btn-outline-primary:hover { background-color: #8B004B; color: #fff; }
    .hero { background: linear-gradient(to right, #8B004B, #ad1457); color:#fff; padding:2rem 1rem; text-align:center; }
    .sidebar { background:#fff; border-right:1px solid #e5e5e5; height:calc(100vh - 56px - 64px); padding-top:1rem; }
    .sidebar a { color:#333; display:block; padding:.75rem 1.5rem; text-decoration:none; }
    .sidebar a.active, .sidebar a:hover { background:#f1f1f1; color:#8B004B; }
    .content { padding:2rem; }
    .table-responsive { margin-top:1rem; background:#fff; border-radius:.5rem; box-shadow:0 .25rem .5rem rgba(0,0,0,0.1); }
    .table-responsive table { table-layout: fixed; width:100%; }
    .table-responsive th, .table-responsive td {
      width: calc(100% / 7);
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap; vertical-align:middle;
    }
    th { cursor:pointer; user-select:none; }
    th .sort-icon { font-size:.8rem; margin-left:.3rem; }
    .table-danger { background:#f8d7da !important; }
    .pagination { justify-content:center; }
    .editable:hover { background:#e9ecef; }
    .text-end { text-align:right; }
    .toast-container { position:fixed; bottom:1rem; right:1rem; z-index:1055; }
    .modal-input .modal-body { text-align: center; }
    .modal-input input, .modal-input select { max-width: 180px; margin:0 auto; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="dashboardadmin.html">Toko Baju Sahabat</a>
      <div class="d-flex align-items-center ms-auto" style="gap:.5rem;">
        <button id="logout" class="btn btn-outline-primary btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <h1>Stok & Manajemen</h1>
    <p>Kelola stok & produk secara efisien dengan fitur lengkap</p>
  </section>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 sidebar d-none d-md-block">
  <a href="dashboardadmin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="produkadmin.html" class="active"><i class="bi bi-tags me-2"></i>Kelola Produk</a>
  <a href="stok.html"><i class="bi bi-box-seam me-2"></i>Manajemen Stok</a>
  <a href="pembelian.html"><i class="bi bi-download me-2"></i>Pembelian (Barang Masuk)</a>
  <a href="penjualan.html"><i class="bi bi-upload me-2"></i>Penjualan (Barang Keluar)</a>
  <a href="offline.html"><i class="bi bi-shop me-2"></i>Penjualan Offline</a>
  <a href="kelolapesanan.html"><i class="bi bi-inboxes me-2"></i>Kelola Pesanan Online</a>
  <a href="laporan.html"><i class="bi bi-file-earmark-bar-graph me-2"></i>Laporan Stok</a>
  <!-- ✅ Menu baru ditambahkan di sini -->
  <a href="laporanpenjualan.html"><i class="bi bi-journal-text me-2"></i>Laporan Penjualan</a>
  <a href="grafik.html"><i class="bi bi-bar-chart me-2"></i>Grafik</a>
  <a href="pengaturan.html"><i class="bi bi-gear me-2"></i>Pengaturan Admin</a>
</nav>
      <!-- Main Content -->
      <main class="col-md-10 content">
        <div class="d-flex flex-wrap justify-content-between gap-2 mb-3">
          <div class="d-flex gap-2 align-items-center">
            <a href="tambahproduk.html" class="btn btn-primary btn-sm">Tambah Produk</a>
            <input type="checkbox" id="selectAll"/><label for="selectAll"> Pilih Semua</label>
            <button id="bulkDelete" class="btn btn-danger btn-sm">Hapus</button>
            <button id="bulkDecrease" class="btn btn-warning btn-sm">Kurangi Stok</button>
            <button id="bulkIncrease" class="btn btn-success btn-sm">Tambah Stok</button>
            <button id="bulkStatus" class="btn btn-info btn-sm">Ubah Status</button>
            <button id="bulkCategory" class="btn btn-primary btn-sm">Ubah Kategori</button>
          </div>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input type="text" id="searchInput" class="form-control w-auto" placeholder="Cari produk..." />
            <select id="categoryFilter" class="form-select w-auto"><option value="">Semua Kategori</option></select>
            <select id="statusFilter" class="form-select w-auto"><option value="">Semua Status</option></select>
            <button id="exportSelected" class="btn btn-outline-primary btn-sm">Export Selected</button>
            <button id="exportCsv" class="btn btn-outline-primary btn-sm">Export CSV</button>
            <div class="dropdown">
              <button class="btn btn-light btn-sm dropdown-toggle" data-bs-toggle="dropdown">Columns</button>
              <ul class="dropdown-menu p-2">
                <li><input type="checkbox" class="col-toggle" data-col="0" checked /> Nama</li>
                <li><input type="checkbox" class="col-toggle" data-col="1" checked /> Harga</li>
                <li><input type="checkbox" class="col-toggle" data-col="2" checked /> Kategori</li>
                <li><input type="checkbox" class="col-toggle" data-col="3" checked /> Stok</li>
                <li><input type="checkbox" class="col-toggle" data-col="4" checked /> Status</li>
                <li><input type="checkbox" class="col-toggle" data-col="5" checked /> Gambar</li>
              </ul>
            </div>
          </div>
        </div>
        <!-- Table -->
        <div class="table-responsive">
          <table class="table table-striped mb-0">
            <thead class="table-light">
              <tr>
                <th></th>
                <th data-sort="nama">Nama <i class="sort-icon"></i></th>
                <th data-sort="harga" class="text-end">Harga <i class="sort-icon"></i></th>
                <th data-sort="kategori">Kategori <i class="sort-icon"></i></th>
                <th data-sort="stok" class="text-end">Stok <i class="sort-icon"></i></th>
                <th data-sort="statusProduk">Status <i class="sort-icon"></i></th>
                <th>Gambar</th>
              </tr>
            </thead>
            <tbody id="stockTbody"></tbody>
          </table>
        </div>
        <!-- Pagination -->
        <nav class="mt-3"><ul class="pagination"></ul></nav>
      </main>
    </div>
  </div>

  <!-- Modal Input -->
  <div class="modal fade modal-input" id="inputModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="inputModalForm" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="inputModalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="inputModalBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary" id="inputModalOk">OK</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Konfirmasi -->
  <div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Konfirmasi</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="confirmModalMsg">Yakin?</div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="button" id="confirmModalOk" class="btn btn-danger">Ya, Lanjutkan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-container">
    <div id="notifToast" class="toast align-items-center text-white bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="notifToastMsg"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let products = [], filtered = [];
      let sortBy = 'stok', sortDir = 1, currentPage = 1, perPage = 10;
      const toastNotif = new bootstrap.Toast(document.getElementById('notifToast'));
      const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
      const inputModal = new bootstrap.Modal(document.getElementById('inputModal'));
      let confirmCallback = null, inputCallback = null;
    
      const formatRupiah = num => new Intl.NumberFormat('id-ID',{ style:'currency', currency:'IDR' }).format(num);
    
      function showNotif(msg, type='success') {
        const notif = document.getElementById('notifToast');
        const notifMsg = document.getElementById('notifToastMsg');
        notifMsg.textContent = msg;
        notif.classList.remove('bg-success','bg-danger','bg-warning');
        notif.classList.add('bg-' + type);
        toastNotif.show();
      }
    
      function showConfirm(msg, callback) {
        document.getElementById('confirmModalMsg').textContent = msg;
        confirmCallback = callback;
        confirmModal.show();
      }
      document.getElementById('confirmModalOk').onclick = () => {
        confirmModal.hide();
        if (confirmCallback) confirmCallback();
        confirmCallback = null;
      };
    
      function showInputModal({ title, html, callback }) {
        document.getElementById('inputModalTitle').textContent = title;
        document.getElementById('inputModalBody').innerHTML = html;
        inputCallback = callback;
        inputModal.show();
      }
      document.getElementById('inputModalForm').onsubmit = e => {
        e.preventDefault();
        const formEl = document.getElementById('inputModalForm');
        const formData = new FormData(formEl);
        let data = {};
        formData.forEach((v,k)=>data[k]=v);
        inputModal.hide();
        if (inputCallback) inputCallback(data);
        inputCallback = null;
      };
    
      document.getElementById('logout').onclick = () => {
        localStorage.removeItem('adminToken');
        window.location.href = 'masukadmin.html';
      };
    
      async function loadData() {
        const res = await fetch('/api/produk', {
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('adminToken') }
        });
        if (!res.ok) { showNotif('Gagal memuat produk', 'danger'); return; }
        products = await res.json();
        populateFilters();
        filtered = [...products];
        renderTable();
        renderPagination();
      }
    
      function populateFilters() {
        const cats = new Set(), stats = new Set();
        products.forEach(p => {
          if (p.kategori) cats.add(p.kategori);
          if (p.statusProduk) stats.add(p.statusProduk);
        });
        const cf = document.getElementById('categoryFilter'),
              sf = document.getElementById('statusFilter');
        cf.innerHTML = '<option value="">Semua Kategori</option>';
        sf.innerHTML = '<option value="">Semua Status</option>';
        cats.forEach(c => cf.add(new Option(c,c)));
        stats.forEach(s => sf.add(new Option(s,s)));
      }
    
      function applyFilters() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const stat = document.getElementById('statusFilter').value;

  filtered = products.filter(p =>
    p.nama.toLowerCase().includes(q) &&
    (!cat || p.kategori === cat) &&
    (!stat || p.statusProduk === stat)
  );
  currentPage = 1;
  renderTable();
  renderPagination();
}
    
      function sumStock(stokObj) {
        if (!stokObj) return 0;
        let sum = 0;
        for (let key in stokObj) {
          sum += Number(stokObj[key] || 0);
        }
        return sum;
      }
    
      function stokToString(stokObj) {
        if (!stokObj) return '-';
        return Object.entries(stokObj).map(([uk, val]) => `${uk}:${val}`).join(', ');
      }
    
      function renderTable() {
        let arr = [...filtered];
        if (sortBy) {
          arr.sort((a,b)=>( (typeof a[sortBy]==='string'
            ? a[sortBy].localeCompare(b[sortBy])
            : sumStock(a.stok)-sumStock(b.stok)
          ) * sortDir ));
        }
        const start = (currentPage-1)*perPage,
              pageItems = arr.slice(start, start+perPage),
              tbody = document.getElementById('stockTbody');
        tbody.innerHTML = '';
        pageItems.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="rowChk" data-id="${p._id}"/></td>
            <td>${p.nama}</td>
            <td class="text-end">${formatRupiah(p.harga)}</td>
            <td>${p.kategori||'-'}</td>
            <td class="text-end">${stokToString(p.stok)}</td>
            <td>${p.statusProduk||'-'}</td>
            <td><img src="/api/produk/gambar/${p._id}" style="max-width:50px;"/></td>
          `;
          tbody.appendChild(tr);
        });
      }
    
      function renderPagination() {
        const total = Math.ceil(filtered.length/perPage),
              ul = document.querySelector('.pagination');
        ul.innerHTML = '';
        for (let i=1; i<=total; i++) {
          const li = document.createElement('li');
          li.className = 'page-item' + (i===currentPage ? ' active':'' );
          const a = document.createElement('a');
          a.className = 'page-link'; a.href = '#'; a.textContent = i;
          a.onclick = e => { e.preventDefault(); currentPage = i; renderTable(); renderPagination(); };
          li.appendChild(a);
          ul.appendChild(li);
        }
      }
    
      ['searchInput','categoryFilter','statusFilter']

        .forEach(id => document.getElementById(id).oninput = applyFilters);
    
      document.getElementById('selectAll').onclick = function() {
        document.querySelectorAll('.rowChk').forEach(cb => cb.checked = this.checked);
      };
      function selIds() {
        return Array.from(document.querySelectorAll('.rowChk:checked'))
          .map(cb => cb.dataset.id);
      }
    
      async function bulkAction(urlTpl, method, body) {
        const ids = selIds();
        await Promise.all(ids.map(id =>
          fetch(urlTpl.replace(':id', id), {
            method,
            headers: {
              'Content-Type':'application/json',
              'Authorization':'Bearer '+localStorage.getItem('adminToken')
            },
            body: body ? JSON.stringify(body) : undefined
          })
        ));
        showNotif('Aksi berhasil');
        loadData();
      }
    
      // ================= MODIF TOMBOL KURANG / TAMBAH STOK =================
      function handleStockChange(isIncrease) {
        const ids = selIds();
        if (!ids.length) return showNotif('Pilih produk dulu', 'warning');
        // ambil ukuran dari produk pertama yang dipilih
        const prod = products.find(p => p._id === ids[0]);
        if (!prod || !prod.stok) return showNotif('Produk tidak punya data stok', 'danger');
        const ukuranList = Object.keys(prod.stok);
        const html = `
          <label class="form-label">Pilih Ukuran:</label>
          <select class="form-select mb-3" name="ukuran" required>
            ${ukuranList.map(u => `<option value="${u}">${u}</option>`).join('')}
          </select>
          <label class="form-label">Jumlah ${isIncrease ? 'Tambahan' : 'Pengurangan'}:</label>
          <input type="number" class="form-control" name="jumlah" min="1" required />
        `;
        showInputModal({
          title: (isIncrease ? 'Tambah' : 'Kurangi') + ' Stok',
          html,
          callback: data => {
            let amt = parseInt(data.jumlah);
            if (isNaN(amt) || amt <= 0) return;
            bulkAction('/api/produk/:id/stock','PATCH',{
              ukuran: data.ukuran,
              delta: isIncrease ? amt : -amt
            });
          }
        });
      }
      document.getElementById('bulkDecrease').onclick = () => handleStockChange(false);
      document.getElementById('bulkIncrease').onclick = () => handleStockChange(true);
      // ======================================================================
    
      document.getElementById('bulkDelete').onclick = () => {
        const ids = selIds();
        if (!ids.length) return showNotif('Pilih produk dulu', 'warning');
        showConfirm(`Hapus ${ids.length} produk terpilih?`, () =>
          bulkAction('/api/produk/:id','DELETE')
        );
      };
    
      document.getElementById('bulkStatus').onclick = () => {
        const ids = selIds();
        if (!ids.length) return showNotif('Pilih produk dulu', 'warning');
        let allStatus = Array.from(new Set(products.map(p => p.statusProduk).filter(Boolean)));
        showInputModal({
          title: 'Ubah Status Produk',
          html: `<label class="form-label">Pilih status baru:</label>
                 <select class="form-select" name="statusProduk" required>
                   ${(allStatus.length ? allStatus : ['Barang Baru','Barang Populer']).map(s=>`<option value="${s}">${s}</option>`).join('')}
                 </select>`,
          callback: data => {
            bulkAction('/api/produk/:id','PATCH',{statusProduk:data.statusProduk});
          }
        });
      };
    
      document.getElementById('bulkCategory').onclick = () => {
        const ids = selIds();
        if (!ids.length) return showNotif('Pilih produk dulu', 'warning');
        let allCats = Array.from(new Set(products.map(p => p.kategori).filter(Boolean)));
        showInputModal({
          title: 'Ubah Kategori Produk',
          html: `<label class="form-label">Pilih kategori baru:</label>
                 <select class="form-select" name="kategori" required>
                   ${(allCats.length ? allCats : ['Baju Wanita','Baju Pria','Baju Anak-anak','Busana Muslim']).map(c=>`<option value="${c}">${c}</option>`).join('')}
                 </select>`,
          callback: data => {
            bulkAction('/api/produk/:id','PATCH',{kategori:data.kategori});
          }
        });
      };
    
      document.getElementById('exportCsv').onclick = () => {
        let csv = 'Nama,Harga,Kategori,Stok,Status\n';
        filtered.forEach(p=>{ csv += `"${p.nama}",${p.harga},"${p.kategori}","${stokToString(p.stok)}","${p.statusProduk||''}"\n`; });
        const blob = new Blob([csv],{type:'text/csv'}), url = URL.createObjectURL(blob),
              a = document.createElement('a');
        a.href = url; a.download = 'stok.csv'; a.click(); URL.revokeObjectURL(url);
      };
      document.getElementById('exportSelected').onclick = () => {
        const ids = selIds(); if (!ids.length) return showNotif('Pilih produk dulu', 'warning');
        let csv = 'Nama,Harga,Kategori,Stok,Status\n';
        products.filter(p=>ids.includes(p._id)).forEach(p => {
          csv += `"${p.nama}",${p.harga},"${p.kategori}","${stokToString(p.stok)}","${p.statusProduk||''}"\n`;
        });
        const blob = new Blob([csv],{type:'text/csv'}), url = URL.createObjectURL(blob),
              a = document.createElement('a');
        a.href = url; a.download = 'selected.csv'; a.click(); URL.revokeObjectURL(url);
      };
    
      loadData();
    });
    </script>
    
    
</body>
</html>
