<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Detail Pesanan | Toko Baju Sahabat</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background:#f8f9fa; font-family: system-ui,sans-serif;}
    .btn-toko-outline {
      border-color: #8B004B !important;
      color: #8B004B !important;
      background: transparent;
      transition: background 0.2s, color 0.2s;
    }
    .btn-toko-outline:hover, .btn-toko-outline:focus {
      background-color: #8B004B !important;
      color: #fff !important;
      border-color: #8B004B !important;
    }
    .sidebar { background:#fff; border-right:1px solid #e5e5e5; height:calc(100vh - 56px); padding-top:1rem; }
    .sidebar a { color:#333; display:block; padding:.75rem 1.5rem; text-decoration:none; }
    .sidebar a.active, .sidebar a:hover { background:#f1f1f1; color:#8B004B; }
    .content { padding:2rem 2vw; }
    .main-card { background:#fff; border-radius:15px; box-shadow:0 6px 20px #0001; padding:2.5rem 2.5rem 2rem; margin-bottom:2rem; max-width:900px; margin-left:auto; margin-right:auto;}
    .section-title {color:#8B004B; font-weight:700;}
    .bukti-img {max-width:350px; max-height:320px; border-radius:12px; border:2px solid #e5e5e5; box-shadow:0 1px 8px #0002;}
    .table th, .table td {vertical-align:middle;}
    .badge {font-size:1em;}
    @media (max-width: 768px) {
      .main-card {padding:1.2rem;}
      .content {padding:.5rem;}
      .bukti-img {max-width:100%;}
    }
    .timeline-admin {margin: 0 0 1.5rem 0; padding: 0; list-style: none;}
    .timeline-admin li {position: relative; padding: 0 0 0.7rem 1.4rem;}
    .timeline-admin li:before {
      content: '';
      position: absolute; left: 0.2rem; top: 0.32em; width: 0.7em; height: 0.7em;
      border-radius: 50%; background: #8B004B33;
      border: 2.5px solid #8B004B;
    }
    .timeline-admin li.done:before { background: #8B004B; }
    .timeline-admin li.current:before { background: #8B004B; border-color: #FFC107; }
    .timeline-admin li.rejected:before { background: #e14c61; border-color: #e14c61;}
    .timeline-admin li small { color:#666; font-size:.93em; margin-left:.4rem;}
    .badge-retur {font-size:.98em; font-weight:600; padding:.35em 1.1em; border-radius:.7em; margin-left:8px;}
    .badge-retur.menunggu {background:#fff3cd; color:#8B7300;}
    .badge-retur.diproses  {background:#e7dfff; color:#6c24b7;}
    .badge-retur.diterima  {background:#d2ffe3; color:#008B2F;}
    .badge-retur.ditolak   {background:#ffe2e2; color:#e14c61;}
    .badge-retur.kosong    {background:#eaeaea; color:#999;}
  </style>
  <script>
    const token = localStorage.getItem('adminToken');
    if (!token) {
      alert('Silakan login sebagai admin!');
      window.location.href = 'loginadmin.html';
    }
    function getOrderId() {
      return new URLSearchParams(window.location.search).get('id');
    }
  </script>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="dashboardadmin.html">Toko Baju Sahabat</a>
  </div>
</nav>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-2 sidebar d-none d-md-block">
  <a href="dashboardadmin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="produkadmin.html" class="active"><i class="bi bi-tags me-2"></i>Kelola Produk</a>
  <a href="stok.html"><i class="bi bi-box-seam me-2"></i>Manajemen Stok</a>
  <a href="pembelian.html"><i class="bi bi-download me-2"></i>Pembelian (Barang Masuk)</a>
  <a href="penjualan.html"><i class="bi bi-upload me-2"></i>Penjualan (Barang Keluar)</a>
  <a href="offline.html"><i class="bi bi-shop me-2"></i>Penjualan Offline</a>
  <a href="kelolapesanan.html"><i class="bi bi-inboxes me-2"></i>Kelola Pesanan Online</a>
  <a href="laporan.html"><i class="bi bi-file-earmark-bar-graph me-2"></i>Laporan Stok</a>
  <!-- âœ… Menu baru ditambahkan di sini -->
  <a href="laporanpenjualan.html"><i class="bi bi-journal-text me-2"></i>Laporan Penjualan</a>
  <a href="grafik.html"><i class="bi bi-bar-chart me-2"></i>Grafik</a>
  <a href="pengaturan.html"><i class="bi bi-gear me-2"></i>Pengaturan Admin</a>
</nav>
    <!-- Main Content -->
    <main class="col-md-10 content">
      <div class="main-card mb-4">
        <h2 class="section-title mb-3">Detail Pesanan</h2>
        <div id="detailContainer"></div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
async function loadDetail() {
  const id = getOrderId();
  const c = document.getElementById('detailContainer');
  if (!id) { c.innerText = 'ID pesanan tidak ditemukan.'; return; }

  const res = await fetch(`/api/admin/pembayarans/${id}`, {
    headers:{ 'Authorization':'Bearer '+token }
  });
  if (!res.ok) { c.innerText = 'Gagal memuat detail pesanan.'; return; }
  const data = await res.json();
  const o = data.pesanan;
  if (!o) { c.innerText = 'Pesanan tidak ditemukan.'; return; }

  // Hitung berat
  let totalBeratGram = 0;
  (o.items||[]).forEach(i => totalBeratGram += (i.berat||0)*i.jumlah);
  const beratAkurat = (totalBeratGram/1000).toFixed(2) + ' kg';
  const beratBulat = Math.ceil(totalBeratGram/1000) + ' kg';

  // Mapping timeline & badges
  const statusList = [
    { key: "Menunggu Konfirmasi", label: "Menunggu Konfirmasi", date: o.createdAt },
    { key: "Diproses", label: "Diproses", date: o.diprosesAt },
    { key: "Ditolak", label: "Ditolak", date: o.status==="Ditolak"? o.updatedAt : null },
    { key: "Dikirim", label: "Dikirim", date: o.dikirimAt },
    { key: "Diterima", label: "Diterima", date: o.diterimaAt },
    { key: "Selesai", label: "Selesai", date: o.selesaiAt }
  ];
  let idxAktif = statusList.findIndex(s => s.key === o.status);
  if (o.status === "Ditolak") idxAktif = 2;

  function formatDate(d) { if(!d) return '-'; return new Date(d).toLocaleString('id-ID'); }
  function badgeStatus(s) {
    switch(s) {
      case "Diproses": return "badge bg-warning text-dark";
      case "Dikirim":  return "badge bg-info text-dark";
      case "Diterima":
      case "Selesai":  return "badge bg-success";
      case "Ditolak":  return "badge bg-danger";
      default:         return "badge bg-secondary";
    }
  }
  function badgeRetur(st) {
    if (!st) return '';
    const map = {
      "Menunggu Konfirmasi":"menunggu",
      "Diproses":"diproses",
      "Diterima":"diterima",
      "Ditolak":"ditolak"
    };
    return `<span class="badge-retur ${map[st]||''}">${st}</span>`;
  }

  // Timeline HTML
  let timelineHTML = `<ol class="timeline-admin">`;
  statusList.forEach((step, idx) => {
    let cls = idx < idxAktif ? 'done'
            : idx === idxAktif ? (o.status==="Ditolak"?"current rejected":"current")
            : '';
    timelineHTML += `<li class="${cls}">${step.label}<small>${formatDate(step.date)}</small></li>`;
  });
  timelineHTML += `</ol>`;

  // Blok Info Retur jika ada
  let returBlock = "";
  if (o.retur && o.retur.status) {
    returBlock = `
      <div class="mb-4 mt-2 border rounded py-3 px-3 bg-light">
        <h5 class="mb-2"><i class="bi bi-arrow-counterclockwise"></i>
          Info Retur Baju ${badgeRetur(o.retur.status)}
        </h5>
        <div class="mb-2"><strong>Alasan:</strong> ${o.retur.alasan||'-'}</div>
        <div class="mb-2"><strong>Deskripsi:</strong> ${o.retur.deskripsi||'-'}</div>
        <div class="mb-2"><strong>Ajukan:</strong> ${formatDate(o.retur.createdAt)}</div>
        <div class="mb-2"><strong>Update:</strong> ${formatDate(o.retur.updatedAt)}</div>
        ${o.retur.bukti?.data?`<div class="mb-3 text-center">
            <b>Foto Bukti Retur:</b><br>
            <img src="/api/admin/pembayarans/${o._id}/retur/bukti" class="bukti-img" alt="Bukti Retur"
                 onerror="this.outerHTML='<small class=&#39;text-muted&#39;>Gagal memuat gambar bukti.</small>'"/>
          </div>`:""}
        <div class="mb-2"><strong>Bank:</strong> ${o.retur.bank||'-'}</div>
        <div class="mb-2"><strong>Rek:</strong> ${o.retur.rekening||'-'}</div>
        <div class="mb-2"><strong>Pemilik:</strong> ${o.retur.pemilik||'-'}</div>
      </div>`;
  }

  // Render seluruh detail
  c.innerHTML = `
    <div class="row">
      <div class="col-lg-6 mb-4">
        <div class="mb-2"><strong>ID Pesanan:</strong> ${o._id}</div>
        <div class="mb-2"><strong>Tanggal Order:</strong> ${formatDate(o.tanggal)}</div>
        <div class="mb-2"><strong>Status:</strong>
          <span class="${badgeStatus(o.status)}">${o.status}</span>
        </div>
        <div class="mb-2"><strong>Email:</strong> ${o.email}</div>
        <div class="mb-2"><strong>Nama Penerima:</strong> ${o.namaPenerima||'-'}</div>
        <div class="mb-2"><strong>No. Telepon:</strong> ${o.phone||'-'}</div>
        <div class="mb-2"><strong>Metode Pembayaran:</strong> ${o.metode}</div>
        ${o.metode==='Transfer'? `<div class="mb-2"><strong>Nama Rekening:</strong> ${o.namaRekening||'-'}</div>` : ''}
        <div class="mb-2"><strong>Timeline Status:</strong>${timelineHTML}</div>
      </div>
      <div class="col-lg-6 mb-4">
        <div class="mb-2"><strong>Alamat Pengiriman:</strong><br>
          ${o.detailPesanan?.alamat||'-'}<br>
          ${o.detailPesanan?.kota||'-'}, ${o.detailPesanan?.provinsi||'-'}
        </div>
        <div class="mb-2"><strong>Kurir:</strong> ${o.detailPesanan?.kurir||'-'}</div>
        <div class="mb-2"><strong>Resi:</strong> ${o.detailPesanan?.resi||'-'}</div>
        <div class="mb-2"><strong>Subtotal:</strong> Rp ${o.subtotal?.toLocaleString('id-ID')||'0'}</div>
        <div class="mb-2"><strong>Ongkir:</strong> Rp ${o.detailPesanan?.ongkir?.toLocaleString('id-ID')||'0'}</div>
        <div class="mb-2"><strong>Total:</strong> Rp ${o.total?.toLocaleString('id-ID')||'0'}</div>
        <div class="mb-2"><strong>Berat Akurat:</strong> ${beratAkurat}</div>
        <div class="mb-2"><strong>Berat Dibulatkan:</strong> ${beratBulat}</div>
      </div>
    </div>

    <div class="mb-4">
      <h5 class="mb-2"><i class="bi bi-bag"></i> Daftar Produk</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>No</th>
              <th>Nama Produk</th>
              <th>Ukuran</th>
              <th>Jumlah</th>
              <th>Harga</th>
              <th>Total</th>
              <th>Berat/item</th>
              <th>ID Produk</th>
            </tr>
          </thead>
          <tbody>
            ${(o.items||[]).map((i,idx)=>`
              <tr>
                <td>${idx+1}</td>
                <td>${i.nama}</td>
                <td>${i.ukuran||'-'}</td>
                <td>${i.jumlah}</td>
                <td>Rp ${i.harga?.toLocaleString('id-ID')||'0'}</td>
                <td>Rp ${(i.harga*i.jumlah)?.toLocaleString('id-ID')||'0'}</td>
                <td>${i.berat||0} gr</td>
                <td>${i.produkId||'-'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>

    ${returBlock}

    ${o.metode==='Transfer' ? `
      <div class="mb-4 text-center">
        <h5 class="mb-2"><i class="bi bi-receipt"></i> Bukti Transfer</h5>
        <img src="/api/pembayaran/bukti/${o._id}" class="bukti-img" alt="Bukti Transfer"/>
      </div>
    ` : ''}

    <div>
      <a href="kelolapesanan.html" class="btn btn-toko-outline">
        <i class="bi bi-inboxes"></i> Kembali ke Kelola Pesanan
      </a>
    </div>
  `;
}

document.addEventListener('DOMContentLoaded', loadDetail);
</script>
</body>
</html>
