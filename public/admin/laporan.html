<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Laporan Stok — Dashboard Admin</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    html, body { font-family: system-ui, sans-serif; background: #f8f9fa; margin:0; height:100%; }
    .navbar .btn-outline-primary { border-color: #8B004B; color: #8B004B; }
    .navbar .btn-outline-primary:hover { background-color: #8B004B; color: #fff; }
    .hero { background: linear-gradient(to right, #8B004B, #ad1457); color:#fff; padding:2rem 1rem; text-align:center; }
    .sidebar { background:#fff; border-right:1px solid #e5e5e5; height:calc(100vh - 56px - 64px); padding-top:1rem; }
    .sidebar a { color:#333; display:block; padding:.75rem 1.5rem; text-decoration:none; }
    .sidebar a.active, .sidebar a:hover { background:#f1f1f1; color:#8B004B; }
    .content { padding:2rem; }
    .table-responsive { margin-top:1rem; background:#fff; border-radius:.5rem; box-shadow:0 .25rem .5rem rgba(0,0,0,0.1); }
    .table-responsive th, .table-responsive td {
      vertical-align:middle; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    th { cursor:pointer; user-select:none; }
    th .sort-icon { font-size:.8rem; margin-left:.3rem; }
    .table-danger { background:#f8d7da !important; }
    .table-warning { background:#fff3cd !important; }
    .table-success { background:#d4edda !important; }
    .pagination { justify-content:center; }
    .badge-kritis { background:#dc3545 !important; color:white; }
    .badge-menipis { background:#ffc107 !important; color:black; }
    .badge-aman { background:#28a745 !important; color:white; }
    .badge-habis { background:#212529 !important; color:white; }
    .warning-section {
      background: #f8d7da;
      border: 1px solid #f5c2c7;
      border-radius: .25rem;
      padding: .75rem 1rem;
      margin-bottom: 1rem;
      color: #842029;
    }
    .text-size-bad { font-weight:bold; }
  </style>
</head>
<body> 
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="dashboardadmin.html">Toko Baju Sahabat</a>
      <div class="d-flex align-items-center ms-auto" style="gap:.5rem;">
        <button id="logout" class="btn btn-outline-primary btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <h1>Laporan Stok</h1>
    <p>Ringkasan status stok produk per size: Aman, Menipis, Kritis, atau Habis</p>
  </section>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav class="col-md-2 sidebar d-none d-md-block">
  <a href="dashboardadmin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="produkadmin.html" class="active"><i class="bi bi-tags me-2"></i>Kelola Produk</a>
  <a href="stok.html"><i class="bi bi-box-seam me-2"></i>Manajemen Stok</a>
  <a href="pembelian.html"><i class="bi bi-download me-2"></i>Pembelian (Barang Masuk)</a>
  <a href="penjualan.html"><i class="bi bi-upload me-2"></i>Penjualan (Barang Keluar)</a>
  <a href="offline.html"><i class="bi bi-shop me-2"></i>Penjualan Offline</a>
  <a href="kelolapesanan.html"><i class="bi bi-inboxes me-2"></i>Kelola Pesanan Online</a>
  <a href="laporan.html"><i class="bi bi-file-earmark-bar-graph me-2"></i>Laporan Stok</a>
  <!-- ✅ Menu baru ditambahkan di sini -->
  <a href="laporanpenjualan.html"><i class="bi bi-journal-text me-2"></i>Laporan Penjualan</a>
  <a href="grafik.html"><i class="bi bi-bar-chart me-2"></i>Grafik</a>
  <a href="pengaturan.html"><i class="bi bi-gear me-2"></i>Pengaturan Admin</a>
</nav>

      <!-- Main Content -->
      <main class="col-md-10 content">
        <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
          <input type="text" id="searchInput" class="form-control w-auto" placeholder="Cari produk..." />
          <select id="categoryFilter" class="form-select w-auto"><option value="">Semua Kategori</option></select>
          <input type="number" id="stockMin" class="form-control form-control-sm" placeholder="Stok Min" style="width:90px;" min="0"/>
          <input type="number" id="stockMax" class="form-control form-control-sm" placeholder="Stok Max" style="width:90px;" min="0"/>
          <button id="exportCsv" class="btn btn-outline-primary btn-sm">Export CSV</button>
        </div>

        <!-- Peringatan Stok Kritis/Habis -->
        <div id="warningKritis" class="alert alert-danger d-none" role="alert" aria-live="polite">
          <h5><i class="bi bi-exclamation-circle-fill"></i> Peringatan Stok Kritis / Habis</h5>
          <ul id="listKritis" style="margin-left: 1rem;"></ul>
        </div>

        <!-- Peringatan Stok Menipis -->
        <div id="warningMenipis" class="alert alert-warning d-none" role="alert" aria-live="polite">
          <h5><i class="bi bi-exclamation-triangle-fill"></i> Peringatan Stok Menipis</h5>
          <ul id="listMenipis" style="margin-left: 1rem;"></ul>
        </div>

        <!-- Tabel Laporan -->
        <div class="table-responsive">
          <table class="table table-striped mb-0" id="laporanTable">
            <thead class="table-light">
              <tr>
                <th>Nama</th>
                <th>Kategori</th>
                <th>Stok per Size</th>
                <th>Status</th>
                <th>Catatan</th>
              </tr>
            </thead>
            <tbody id="laporanTbody"></tbody>
          </table>
        </div>
        <nav class="mt-3"><ul class="pagination"></ul></nav>
      </main>
    </div>
  </div>
</body>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let products = [], filtered = [];
      let currentPage = 1, perPage = 12;

      // Batas penanda per size (versi revisi)
      // 0 = habis, 1-39 = kritis, 40-79 = menipis, 80+ = aman
      function statusStokVal(stok) {
        if (stok === undefined || stok === null) return 'Habis';
        if (stok === 0) return 'Habis';
        if (stok < 40) return 'Kritis';
        if (stok < 80) return 'Menipis';
        return 'Aman';
      }

      function badgeStatus(stok) {
        const st = statusStokVal(stok);
        if (st === 'Aman') return `<span class="badge badge-aman">${stok}</span>`;
        if (st === 'Menipis') return `<span class="badge badge-menipis">${stok}</span>`;
        if (st === 'Kritis') return `<span class="badge badge-kritis">${stok}</span>`;
        return `<span class="badge badge-habis">${stok}</span>`;
      }

      function statusLabel(stok) {
        const st = statusStokVal(stok);
        if (st === 'Aman') return `<span class="badge bg-success">Aman</span>`;
        if (st === 'Menipis') return `<span class="badge bg-warning text-dark">Menipis</span>`;
        if (st === 'Kritis') return `<span class="badge bg-danger">Kritis</span>`;
        return `<span class="badge bg-dark">Habis</span>`;
      }

      async function loadData() {
        const res = await fetch('/api/produk');
        products = await res.json();
        products = products.map(p => {
          let stokObj = (typeof p.stok === "object" && p.stok !== null) ? p.stok : {};
          // Konversi stok Map -> Object jika perlu (jaga2)
          if (typeof stokObj.entries === "function") {
            stokObj = Object.fromEntries(Array.from(stokObj.entries()));
          }
          return { ...p, stokObj };
        });
        populateFilters();
        applyFilters();
      }

      function populateFilters() {
        const categories = new Set(products.map(p => p.kategori).filter(Boolean));
        const catSelect = document.getElementById('categoryFilter');
        catSelect.innerHTML = '<option value="">Semua Kategori</option>';
        categories.forEach(cat => catSelect.add(new Option(cat, cat)));
      }

      function applyFilters() {
        const q = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('categoryFilter').value;
        const smin = +document.getElementById('stockMin').value || -Infinity;
        const smax = +document.getElementById('stockMax').value || Infinity;
        filtered = products.filter(p => {
          if (q && !p.nama.toLowerCase().includes(q)) return false;
          if (cat && p.kategori !== cat) return false;
          // Jika ada size yang memenuhi min/max, lolos filter
          const stokVals = Object.values(p.stokObj || {});
          const total = stokVals.reduce((a, b) => a + (b || 0), 0);
          if (total < smin || total > smax) return false;
          return true;
        });
        currentPage = 1;
        renderTable();
        renderPagination();
        renderWarningSection();
      }

      function renderTable() {
        const laporanTbody = document.getElementById('laporanTbody');
        if (!laporanTbody) return;
        let arr = [...filtered];
        const start = (currentPage - 1) * perPage;
        const pageItems = arr.slice(start, start + perPage);
        laporanTbody.innerHTML = '';

        pageItems.forEach(p => {
          // Tampilkan semua size
          const sizes = Object.keys(p.stokObj || {});
          const sizeCells = sizes.length ? sizes.map(s =>
            `<span class="me-2 ${statusStokVal(p.stokObj[s]) !== 'Aman' ? 'text-size-bad' : ''}">
              ${s.toUpperCase()}: ${badgeStatus(p.stokObj[s])}
            </span>`
          ).join('') : '-';

          // Cari status terburuk (misal: jika ada habis, maka habis)
          let worstStatus = 'Aman';
          for (let s of sizes) {
            const st = statusStokVal(p.stokObj[s]);
            if (st === 'Habis') { worstStatus = 'Habis'; break; }
            if (st === 'Kritis' && worstStatus !== 'Habis') worstStatus = 'Kritis';
            else if (st === 'Menipis' && worstStatus !== 'Kritis' && worstStatus !== 'Habis') worstStatus = 'Menipis';
          }

          laporanTbody.insertAdjacentHTML('beforeend', `
            <tr class="${
              worstStatus === 'Habis' ? 'table-danger' :
              (worstStatus === 'Kritis' ? 'table-danger' :
                (worstStatus === 'Menipis' ? 'table-warning' : 'table-success'))}">
              <td>${p.nama}</td>
              <td>${p.kategori || '-'}</td>
              <td>${sizeCells}</td>
              <td>${statusLabel(worstStatus)}</td>
              <td>${
                worstStatus === 'Menipis' ? 'Segera tambah stok'
                : (worstStatus === 'Kritis' ? 'Stok size tertentu KRITIS (di bawah 40)' 
                : (worstStatus === 'Habis' ? 'Stok size tertentu sudah HABIS' : ''))
              }</td>
            </tr>
          `);
        });
      }

      function renderPagination() {
        const totalPages = Math.ceil(filtered.length / perPage);
        const paginationEl = document.querySelector('.pagination');
        paginationEl.innerHTML = '';
        for (let i=1; i<=totalPages; i++) {
          const li = document.createElement('li');
          li.className = 'page-item' + (i === currentPage ? ' active' : '');
          const a = document.createElement('a');
          a.className = 'page-link';
          a.href = '#';
          a.textContent = i;
          a.onclick = e => {
            e.preventDefault();
            currentPage = i;
            renderTable();
            renderPagination();
          };
          li.appendChild(a);
          paginationEl.appendChild(li);
        }
      }

      // Per size warning
      function renderWarningSection() {
  const kritisBox = document.getElementById('warningKritis');
  const menipisBox = document.getElementById('warningMenipis');
  const kritisList = document.getElementById('listKritis');
  const menipisList = document.getElementById('listMenipis');

  let kritisHabisList = [];
  let menipisArr = [];

  for (let p of filtered) {
    for (let [size, stok] of Object.entries(p.stokObj || {})) {
      const st = statusStokVal(stok);
      const msg = `${p.nama} (${p.kategori || '-'}) [${size.toUpperCase()}]: stok ${stok} (${st})`;

      if (st === 'Kritis' || st === 'Habis') {
        kritisHabisList.push(msg);
      } else if (st === 'Menipis') {
        menipisArr.push(msg);
      }
    }
  }

  // Tampilkan box Kritis/Habis
  if (kritisHabisList.length > 0) {
    kritisBox.classList.remove('d-none');
    kritisList.innerHTML = kritisHabisList.map(w => `<li>${w}</li>`).join('');
  } else {
    kritisBox.classList.add('d-none');
    kritisList.innerHTML = '';
  }

  // Tampilkan box Menipis
  if (menipisArr.length > 0) {
    menipisBox.classList.remove('d-none');
    menipisList.innerHTML = menipisArr.map(w => `<li>${w}</li>`).join('');
  } else {
    menipisBox.classList.add('d-none');
    menipisList.innerHTML = '';
  }
}



      // Export CSV
      document.getElementById('exportCsv').onclick = () => {
        let csv = 'Nama,Kategori,Size,Stok,Status\n';
        for (const p of filtered) {
          for (const [size, stok] of Object.entries(p.stokObj || {})) {
            csv += `"${p.nama}","${p.kategori||''}","${size.toUpperCase()}",${stok},${statusStokVal(stok)}\n`;
          }
        }
        const blob = new Blob([csv], {type:'text/csv'}), url = URL.createObjectURL(blob),
              a = document.createElement('a');
        a.href = url; a.download = 'laporan-stok.csv'; a.click(); URL.revokeObjectURL(url);
      };

      ['searchInput','categoryFilter','stockMin','stockMax'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', applyFilters);
      });

      document.getElementById('logout').onclick = () => {
        localStorage.removeItem('adminToken');
        window.location.href = 'masukadmin.html';
      };

      loadData();
    });
  </script>
</body>
</html>
