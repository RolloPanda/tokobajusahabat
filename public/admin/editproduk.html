<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Edit Produk — Dashboard Admin</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    html, body {
      font-family: system-ui, sans-serif;
      background: #f8f9fa;
      margin: 0;
      height: 100%;
    }
    .navbar-brand { color: #212529 !important; }

    .btn-primary {
      background-color: #8B004B;
      border-color: #8B004B;
    }
    .btn-primary:hover {
      background-color: #ad1457;
      border-color: #ad1457;
    }
    .btn-outline-primary {
      border-color: #8B004B;
      color: #8B004B;
    }
    .btn-outline-primary:hover {
      background-color: #8B004B;
      color: #fff;
    }
    .hero {
      background: linear-gradient(to right, #8B004B, #ad1457);
      color: #fff;
      padding: 2rem 1rem;
      text-align: center;
    }
    .content {
      padding: 2rem 0;
    }
    .form-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .preview-box {
      border: 1px dashed #ccc;
      border-radius: .5rem;
      background: #fff;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .preview-box img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    @media (max-width: 991px) {
      .content { padding: 1rem 0; }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="dashboardadmin.html">Toko Baju Sahabat</a>
    <div class="d-flex align-items-center ms-auto" style="gap:.5rem;">
      <button id="logout" class="btn btn-outline-primary btn-sm">Logout</button>
    </div>
  </div>
</nav>
<nav class="col-md-2 sidebar d-none d-md-block">
  <a href="dashboardadmin.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="produkadmin.html" class="active"><i class="bi bi-tags me-2"></i>Kelola Produk</a>
  <a href="stok.html"><i class="bi bi-box-seam me-2"></i>Manajemen Stok</a>
  <a href="pembelian.html"><i class="bi bi-download me-2"></i>Pembelian (Barang Masuk)</a>
  <a href="penjualan.html"><i class="bi bi-upload me-2"></i>Penjualan (Barang Keluar)</a>
  <a href="offline.html"><i class="bi bi-shop me-2"></i>Penjualan Offline</a>
  <a href="kelolapesanan.html"><i class="bi bi-inboxes me-2"></i>Kelola Pesanan Online</a>
  <a href="laporan.html"><i class="bi bi-file-earmark-bar-graph me-2"></i>Laporan Stok</a>
  <!-- ✅ Menu baru ditambahkan di sini -->
  <a href="laporanpenjualan.html"><i class="bi bi-journal-text me-2"></i>Laporan Penjualan</a>
  <a href="grafik.html"><i class="bi bi-bar-chart me-2"></i>Grafik</a>
  <a href="pengaturan.html"><i class="bi bi-gear me-2"></i>Pengaturan Admin</a>
</nav>
<!-- Hero -->
<section class="hero">
  <h1>Edit Produk</h1>
  <p>Ubah data lengkap produk dan lihat preview gambarnya</p>
</section>

<!-- Form + Preview -->
<div class="content container form-container">
  <div class="row g-4">
    <!-- Form -->
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <form id="editProductForm" enctype="multipart/form-data">
            <input type="hidden" id="productId" />

            <div class="mb-3">
              <label for="nama" class="form-label">Nama Produk</label>
              <input type="text" id="nama" name="nama" class="form-control" required />
            </div>

            <div class="mb-3">
              <label for="harga" class="form-label">Harga</label>
              <input type="text" id="harga" name="harga" class="form-control" required />
            </div>

            <div class="mb-3">
              <label for="kategori" class="form-label">Kategori</label>
              <select id="kategori" name="kategori" class="form-select" required>
                <option value="">-- Pilih Kategori --</option>
                <option value="Baju Wanita">Baju Wanita</option>
                <option value="Baju Pria">Baju Pria</option>
                <option value="Baju Anak-anak">Baju Anak-anak</option>
                <option value="Busana Muslim">Busana Muslim</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="subKategori" class="form-label">Sub-Kategori</label>
              <select id="subKategori" name="subKategori" class="form-select" disabled>
                <option value="">-- Pilih Sub-Kategori --</option>
                <option value="Dress">Dress</option>
                <option value="Blouse">Blouse</option>
                <option value="Tunik">Tunik</option>
                <option value="Gamis">Gamis</option>
                <option value="Rok & Celana">Rok & Celana</option>
              </select>
              <div class="form-text">Hanya untuk kategori Baju Wanita</div>
            </div>

            <div class="mb-3">
              <label for="statusProduk" class="form-label">Status Produk</label>
              <select id="statusProduk" name="statusProduk" class="form-select">
                <option value="">(Tidak ada)</option>
                <option value="Barang Baru">Barang Baru</option>
                <option value="Barang Populer">Barang Populer</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="deskripsi" class="form-label">Deskripsi</label>
              <textarea id="deskripsi" name="deskripsi" class="form-control" rows="3"></textarea>
            </div>

            <div class="mb-3">
              <label for="berat" class="form-label">Berat (gram)</label>
              <input type="number" id="berat" name="berat" class="form-control" min="0" required />
            </div>

            <div class="mb-3">
              <label for="stok" class="form-label">Stok</label>
              <input type="number" id="stok" name="stok" class="form-control" min="0" required />
            </div>

            <div class="mb-3">
              <label for="gambar" class="form-label">Ganti Gambar Produk</label>
              <input type="file" id="gambar" name="gambar" class="form-control" accept="image/*" />
              <div class="form-text">Kosongkan jika tidak ingin mengganti gambar.</div>
            </div>

            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
            <a href="produkadmin.html" class="btn btn-secondary ms-2">Batal</a>
            <div id="message" class="mt-3"></div>
          </form>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="col-md-6">
      <div class="preview-box" id="previewBox">
        <span>Preview Gambar</span>
      </div>
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem('adminToken');
  if (!token) {
    alert('Silakan login terlebih dahulu!');
    window.location.href = 'masukadmin.html';
  }

  // Logout
  document.getElementById('logout').onclick = () => {
    localStorage.removeItem('adminToken');
    window.location.href = 'masukadmin.html';
  };

  // Utility: get ?id=…
  function getParam(name) {
    return new URLSearchParams(window.location.search).get(name);
  }

  // Enable/disable subKategori
  document.getElementById('kategori').addEventListener('change', function() {
    const sub = document.getElementById('subKategori');
    if (this.value === 'Baju Wanita') sub.disabled = false;
    else { sub.disabled = true; sub.value = ''; }
  });

  // Preview gambar
  document.getElementById('gambar').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const box = document.getElementById('previewBox');
    box.innerHTML = '';
    if (!file) {
      box.innerHTML = '<span>Preview Gambar</span>';
      return;
    }
    const reader = new FileReader();
    reader.onload = evt => {
      const img = document.createElement('img');
      img.src = evt.target.result;
      box.appendChild(img);
    };
    reader.readAsDataURL(file);
  });

  // Format Rupiah on harga field
  const hargaInput = document.getElementById('harga');
  hargaInput.addEventListener('input', e => {
    let v = e.target.value.replace(/[^\d]/g, '');
    if (!v) return e.target.value = '';
    e.target.value = new Intl.NumberFormat('id-ID', {
      style: 'currency', currency: 'IDR', minimumFractionDigits: 0
    }).format(v);
  });

  // Load existing product
  async function loadProduct() {
    const id = getParam('id');
    if (!id) {
      alert('ID produk tidak ditemukan');
      return;
    }
    document.getElementById('productId').value = id;
    try {
      const res = await fetch(`/api/produk/${id}`, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      if (!res.ok) throw new Error();
      const p = await res.json();
      // populate
      nama.value = p.nama;
      harga.value = new Intl.NumberFormat('id-ID',{
        style:'currency',currency:'IDR',minimumFractionDigits:0
      }).format(p.harga);
      kategori.value = p.kategori;
      const sub = document.getElementById('subKategori');
      if (p.kategori === 'Baju Wanita') {
        sub.disabled = false;
        sub.value = p.subKategori || '';
      }
      statusProduk.value = p.statusProduk || '';
      deskripsi.value = p.deskripsi || '';
      berat.value = p.berat || 0;
      stok.value = p.stok;
      // preview existing image
      const box = document.getElementById('previewBox');
      box.innerHTML = '';
      const img = document.createElement('img');
      img.src = `/api/produk/gambar/${id}`;
      box.appendChild(img);
    } catch {
      alert('Gagal memuat data produk');
    }
  }

  // Submit edit form
  document.getElementById('editProductForm').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;
    const id = productId.value;
    const data = new FormData();

    data.append('nama', nama.value);
    data.append('harga', harga.value.replace(/[^\d]/g,''));
    data.append('kategori', kategori.value);
    if (!subKategori.disabled) data.append('subKategori', subKategori.value);
    data.append('statusProduk', statusProduk.value);
    data.append('deskripsi', deskripsi.value);
    data.append('berat', berat.value);
    data.append('stok', stok.value);
    if (gambar.files[0]) data.append('gambar', gambar.files[0]);

    try {
      const res = await fetch(`/api/produk/${id}`, {
        method: 'PATCH',
        headers: { 'Authorization': 'Bearer ' + token },
        body: data
      });
      const msg = document.getElementById('message');
      if (res.ok) {
        msg.innerHTML = '<div class="alert alert-success">Produk berhasil diperbarui!</div>';
      } else {
        const err = await res.json();
        msg.innerHTML = `<div class="alert alert-danger">${err.message||'Gagal memperbarui produk'}</div>`;
      }
    } catch {
      document.getElementById('message').innerHTML =
        '<div class="alert alert-danger">Terjadi kesalahan server.</div>';
    }
  });

  document.addEventListener('DOMContentLoaded', loadProduct);
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
