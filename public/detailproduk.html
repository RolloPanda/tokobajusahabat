<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail Produk - Toko Baju Sahabat</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    /* ...style SAMA seperti sebelumnya, TIDAK DIKURANGI... */
    body { font-family: system-ui,sans-serif; background: #f8f9fa; min-height: 100vh;}
    .navbar-brand { color: #8B004B !important; letter-spacing:.5px; }
    .navbar { box-shadow: 0 2px 10px 0 rgba(139,0,75,.05);}
    @media (min-width: 992px) {
      .navbar .dropdown:hover > .dropdown-menu { display: block; margin-top: 0; animation: navDrop .17s;}
      .dropdown-submenu:hover > .dropdown-menu { display: block; left: 100%; top: 0; margin-top: -1px;}
    }
    @keyframes navDrop { from { opacity: 0; transform: translateY(13px);} to { opacity: 1; transform: none;} }
    .navbar .dropdown-menu {
      border-radius: 0.7em; box-shadow: 0 6px 32px #8b004b20; border: 1.5px solid #8b004b0d;
      min-width: 210px; padding: .7em 0; margin-top: 0.6em; transition: box-shadow .13s;
    }
    .navbar .dropdown-menu .dropdown-item {
      padding: .53em 1.3em; transition: background .15s, color .15s; font-size: 1.05em; border-radius: 8px;
    }
    .navbar .dropdown-menu .dropdown-item:active,
    .navbar .dropdown-menu .dropdown-item:focus,
    .navbar .dropdown-menu .dropdown-item:hover {
      background: linear-gradient(90deg, #ffd1eb2a 0%, #8B004B11 100%);
      color: #8B004B; font-weight: 500; box-shadow: 0 2px 7px #8B004B0c;
    }
    .dropdown-divider { border-color:#eee; margin:.3em 0; }
    .dropdown-submenu { position:relative; }
    .dropdown-submenu > .dropdown-menu {
      left: 100%; top: 0; margin-top: -1px; border-radius: 0.7em; box-shadow: 0 6px 32px #8b004b1c;
      border: 1.5px solid #8b004b0d; min-width: 185px; display: none; position: absolute;
    }

    /* ====== UPDATE Mobile Navbar behaviors (digabung dari style produk) ====== */
    @media (max-width:991.98px){
      .navbar .dropdown-menu { position: static !important; box-shadow: none; border-radius: 0.7em; margin-top: .6em; }
      .dropdown-submenu > .dropdown-menu { position: static !important; margin: .25rem 0 .5rem 1.2rem; box-shadow: none; border: none; background: #fff; min-width: unset; display: none; }
      .dropdown-submenu.show > .dropdown-menu { display: block !important; }

      /* tambahan dari style produk */
      .navbar .collapse .d-flex { flex-wrap:wrap; gap:.5rem; }
      .navbar .collapse form { width:100%; order:-1; margin-bottom:.25rem; }
      .navbar .collapse form .form-control { width:100%; }
      .navbar .collapse a.btn, .navbar .collapse button.btn { flex:1 1 auto; min-width:44%; }
    }

    @media (max-width:600px){
      .navbar .dropdown-menu { min-width: 95vw;} .navbar-brand { font-size: 1.12em;}
    }

    .product-detail-container {
      background: #fff; border-radius: 18px; padding: 2.2rem 1.4rem 2rem 1.4rem;
      box-shadow: 0 8px 28px #8b004b11, 0 2px 7px #8b004b09; margin: 40px auto 36px auto; max-width: 920px;
    }
    .product-gallery { background: #fbe8f3; border-radius: 13px; padding: 16px; min-height: 280px; display: flex; align-items: center; justify-content: center;}
    .product-gallery img { width: 100%; max-width: 320px; max-height: 320px; object-fit: contain; border-radius: 10px; box-shadow: 0 2px 12px #8b004b22; background: #fff;}
    .prod-badge { display: inline-block; padding: 0.34em 1.1em 0.34em 0.75em; border-radius: 1em; font-size: .97em; background: linear-gradient(90deg, #ffd5e6 40%, #fff 100%); color: #8b004b; font-weight: 600; margin-right: 8px; margin-bottom: 4px; vertical-align: middle; letter-spacing: 0.02em; box-shadow: 0 1px 5px #8b004b15;}
    .prod-badge.stok { background: linear-gradient(90deg, #ddffe5 40%, #fff 100%); color: #009b57;}
    .prod-badge.habis { background: #ffeaea; color: #c0392b;}
    .prod-title { color: #8B004B; font-size: 1.7rem; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.01em;}
    .prod-kategori { color: #888; font-size: 1.05em; margin-bottom: 9px;}
    .prod-harga { color: #222; font-size: 2rem; font-weight: 700; margin-bottom: 10px; letter-spacing: 0.01em;}
    .prod-deskripsi { color: #444; margin-top: 14px; margin-bottom: 22px; font-size: 1.08em; line-height: 1.6;}
    .prod-btn-group .btn {
      font-size: 1.13em; font-weight: 600; padding: 0.67em 1.3em; border-radius: 8px;
      margin-right: 7px; margin-bottom: 8px; box-shadow: 0 1px 4px #8b004b1c; transition: 0.16s;
    }
    .prod-btn-group .btn-primary { background: #8B004B; border: none; color: #fff;}
    .prod-btn-group .btn-primary:hover { background: #ad1457;}
    .prod-btn-group .btn-outline-primary { border: 2px solid #8B004B; color: #8B004B; background: #fff;}
    .prod-btn-group .btn-outline-primary:hover { background: #8B004B; color: #fff;}
    .recommended-products { margin-top: 36px; margin-bottom: 32px; max-width: 1000px;}
    .recommended-products h4 { color: #8B004B; font-weight: bold; margin-bottom: 22px; font-size: 1.13rem; letter-spacing: .5px;}
    .recommended-products .card { border-radius: 15px; box-shadow: 0 3px 16px #8b004b11; border: none; margin-bottom: 15px; transition: box-shadow 0.18s, transform 0.15s;}
    .recommended-products .card:hover { box-shadow: 0 7px 20px #8b004b18; transform: translateY(-5px) scale(1.03);}
    .recommended-products .card-img-top { border-radius: 15px 15px 0 0; height: 155px; object-fit: cover; background: #fff;}
    .recommended-products .card-title { color: #8B004B; font-size: 1.03em; font-weight: 600; margin-bottom: 5px;}
    .recommended-products .btn { border: 1.5px solid #8B004B; color: #8B004B; font-weight: 600; background: #fff; border-radius: 7px; padding: 0.45em 1em; margin-top: 7px; transition: 0.13s;}
    .recommended-products .btn:hover { background: #8B004B; color: #fff;}
    @media (max-width:900px) { .product-detail-container { padding: 1.2rem .5rem;} }
    @media (max-width:600px){ .product-detail-container { margin-top: 16px; padding: .9rem .3rem; } .prod-title { font-size: 1.19rem; } .prod-harga { font-size: 1.16rem; } .product-gallery { padding: 7px; min-height: 120px; }}
    #toast-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 3000; max-width: 95vw; pointer-events: none; display: flex; flex-direction: column; align-items: center;}
    .toko-toast { min-width: 220px; max-width: 340px; color: #fff; background: linear-gradient(90deg,#8B004B,#ad1457); border-radius: 13px; padding: 1rem 1.25rem; margin-bottom: 13px; box-shadow: 0 4px 22px #8B004B11; display: flex; align-items: center; font-weight: 500; font-size: 1.04rem; opacity: 0; transform: translateY(35px) scale(0.95); animation: slideInCenter .48s forwards; gap: 0.7rem; pointer-events: auto;}
    .toko-toast.toko-toast-error { background: linear-gradient(90deg,#C62828,#FF5252);}
    .toko-toast.toko-toast-info { background: linear-gradient(90deg,#1976D2,#64B5F6);}
    @keyframes slideInCenter { to { opacity: 1; transform: none;} }
</style>

</head>
<body>
  <!-- Navbar (UNCHANGED) -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">Toko Baju Sahabat</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="index.html">Beranda</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Tentang</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="dropdownToko" role="button" data-bs-toggle="dropdown">Toko</a>
          <ul class="dropdown-menu" aria-labelledby="dropdownToko">
            <li><a class="dropdown-item" href="penjualansemua.html">Semua Produk</a></li>
            <li><a class="dropdown-item" href="barangpopuler.html">Barang Populer</a></li>
            <li><a class="dropdown-item" href="barangbaru.html">Barang Baru</a></li>
            <li><hr class="dropdown-divider" /></li>

            <!-- Submenu Baju Wanita -->
            <li class="dropdown-submenu position-relative">
  <a class="dropdown-item d-flex justify-content-between align-items-center" href="bajuwanita.html">
    Baju Wanita
    <button class="dropdown-submenu-toggle btn btn-sm p-0 border-0 bg-transparent" type="button">
      <i class="bi bi-caret-down-fill"></i>
    </button>
  </a>
  <ul class="dropdown-menu">
    <li><a class="dropdown-item" href="dress.html">Dress</a></li>
    <li><a class="dropdown-item" href="blouse.html">Blouse</a></li>
    <li><a class="dropdown-item" href="tunik.html">Tunik</a></li>
    <li><a class="dropdown-item" href="gamis.html">Gamis</a></li>
    <li><a class="dropdown-item" href="rokcelana.html">Rok/Celana</a></li>
  </ul>
</li>
            <li><a class="dropdown-item" href="bajupria.html">Baju Pria</a></li>
            <li><a class="dropdown-item" href="bajuanak.html">Baju Anak</a></li>
            <li><a class="dropdown-item" href="busanamuslim.html">Busana Muslim</a></li>
          </ul>
        </li>
      </ul>

      <!-- Bagian kanan: search + akun -->
      <div class="d-flex align-items-center" style="gap: 0.5rem;">
        <form class="d-flex" action="hasilpencarian.html" method="GET">
          <input class="form-control form-control-sm me-2" type="search" name="q" placeholder="Cari Produk" required />
          <button class="btn btn-outline-success btn-sm" type="submit">Cari</button>
        </form>
        <a id="loginButton" href="login.html" class="btn btn-outline-primary btn-sm">Login</a>
        <a id="registerButton" href="daftarakun.html" class="btn btn-outline-secondary btn-sm">Buat Akun</a>
        <a id="manageAccountButton" href="akun.html" class="btn btn-outline-success btn-sm" style="display:none;">Kelola Akun</a>
        <a id="statusButton" href="statuspesanan.html" class="btn btn-outline-info btn-sm" style="display:none;">Status Pesanan</a>
        <a id="cartButton" href="keranjangbelanja.html" class="btn btn-outline-warning btn-sm position-relative" style="display:none;">
          <i class="bi bi-cart"></i>
          <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
        </a>
        <button id="logoutButton" class="btn btn-outline-danger btn-sm" style="display:none;">Logout</button>
      </div>
    </div>
  </div>
</nav>

<!-- Tambahkan container untuk toast -->
<div id="toast-container"></div>
<div id="toast-container"></div>

<!-- ================= DETAIL PRODUK ================= -->
<div class="container">
  <div class="product-detail-container">
    <div class="row g-4">
      <!-- Gambar -->
      <div class="col-md-5">
        <div class="product-gallery">
          <img id="produk-img" src="" alt="Produk" />
        </div>
      </div>
      <!-- Info produk -->
      <div class="col-md-7">
        <span id="badge-stok" class="prod-badge">Loading...</span>
        <h1 id="produk-nama" class="prod-title">Nama Produk</h1>
        <p id="produk-kategori" class="prod-kategori">Kategori</p>
        <p id="produk-harga" class="prod-harga">Rp 0</p>
        <p id="produk-deskripsi" class="prod-deskripsi">Deskripsi produk ditampilkan di sini...</p>

        <!-- Pilihan ukuran -->
        <div class="mb-3">
          <label for="select-ukuran" class="form-label fw-bold">Pilih Ukuran</label>
          <select id="select-ukuran" class="form-select"></select>
        </div>

        <!-- Input jumlah -->
        <div class="mb-3">
          <label for="input-jumlah" class="form-label fw-bold">Jumlah</label>
          <input type="number" id="input-jumlah" class="form-control" value="1" min="1" />
        </div>

        <!-- Tombol aksi -->
        <div class="prod-btn-group mt-3">
          <button id="btn-tambah" class="btn btn-outline-primary">
            <i class="bi bi-cart-plus"></i> Tambah ke Keranjang
          </button>
          <button id="btn-beli" class="btn btn-primary">
            <i class="bi bi-bag-check"></i> Beli Sekarang
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Produk rekomendasi -->
  <div class="recommended-products">
    <h4>Produk Terkait</h4>
    <div id="rekomendasi" class="row g-3"></div>
  </div>
</div>
  <!-- Dropdown submenu toggle for mobile -->
  <script>
  // ============ NAVBAR MOBILE ============ //
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.dropdown-submenu-toggle').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault(); 
        e.stopPropagation();
        const parent = btn.closest('.dropdown-submenu');
        parent.classList.toggle('show');
        document.querySelectorAll('.dropdown-submenu').forEach(s => { 
          if (s!==parent) s.classList.remove('show'); 
        });
      });
    });
    document.addEventListener('click', () => {
      document.querySelectorAll('.dropdown-submenu').forEach(s => s.classList.remove('show'));
    });
  });

  // ============ DETAIL PRODUK ============ //
  let detail = null;
  const productId = new URLSearchParams(window.location.search).get("id");

  function showToast(msg, type = "success") {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toko-toast toko-toast-' + type;
    let icon = `<i class="bi bi-check-circle-fill"></i>`;
    if(type === "error") icon = `<i class="bi bi-x-circle-fill"></i>`;
    if(type === "info") icon = `<i class="bi bi-info-circle-fill"></i>`;
    toast.innerHTML = icon + `<span style="flex:1;">${msg}</span>`;
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = 0;
      toast.style.transform = "translateY(30px) scale(0.98)";
      setTimeout(() => toast.remove(), 400);
    }, 2100);
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const email = localStorage.getItem("email");
    if (email) {
      document.getElementById('loginButton').style.display = 'none';
      document.getElementById('registerButton').style.display = 'none';
      document.getElementById('logoutButton').style.display = 'inline-block';
      document.getElementById('manageAccountButton').style.display = 'inline-block';
      document.getElementById('statusButton').style.display = 'inline-block';
      document.getElementById('cartButton').style.display = 'inline-block';
      await updateCartCount(email);
    }
    document.getElementById('logoutButton').addEventListener('click', () => {
      localStorage.clear();
      window.location.reload();
    });

    if (!productId) return alert("Produk tidak ditemukan.");
    await loadProduk();

    document.getElementById("btn-tambah").addEventListener("click", async () => {
      if (!email) { showToast("Silakan login terlebih dahulu!", "info"); return; }

      const ukuran = document.getElementById("select-ukuran").value;
      const jumlah = parseInt(document.getElementById("input-jumlah").value) || 1;
      if (!ukuran) {
        showToast("Pilih ukuran produk terlebih dahulu.", "info");
        return;
      }
      if (jumlah < 1) {
        showToast("Jumlah minimal 1.", "info");
        return;
      }
      if (!detail.stok[ukuran] || jumlah > detail.stok[ukuran]) {
        showToast("Stok ukuran tidak cukup.", "error");
        return;
      }

      const produk = { _id: detail._id, nama: detail.nama, harga: detail.harga, ukuran, jumlah };
      try {
        const res = await fetch("/api/keranjang/tambah", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, produk })
        });
        const result = await res.json();
        if (result.success) {
          showToast("Produk ditambahkan ke keranjang!");
          await updateCartCount(email);
        } else {
          showToast(result.message || "Gagal menambahkan.", "error");
        }
      } catch {
        showToast("Terjadi kesalahan.", "error");
      }
    });

    document.getElementById("btn-beli").addEventListener("click", async () => {
      if (!email) { showToast("Silakan login terlebih dahulu!", "info"); return; }

      const ukuran = document.getElementById("select-ukuran").value;
      const jumlah = parseInt(document.getElementById("input-jumlah").value) || 1;
      if (!ukuran) {
        showToast("Pilih ukuran produk terlebih dahulu.", "info");
        return;
      }
      if (jumlah < 1) {
        showToast("Jumlah minimal 1.", "info");
        return;
      }
      if (!detail.stok[ukuran] || jumlah > detail.stok[ukuran]) {
        showToast("Stok ukuran tidak cukup.", "error");
        return;
      }

      const produk = { _id: detail._id, nama: detail.nama, harga: detail.harga, ukuran, jumlah };
      try {
        await fetch("/api/keranjang/tambah", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, produk })
        });
        await updateCartCount(email);
        window.location.href = "halamancheckout.html";
      } catch {
        showToast("Gagal proses ke checkout.", "error");
      }
    });
  });

  async function updateCartCount(email) {
    try {
      const res = await fetch(`/api/keranjang/jumlah/${email}`);
      const data = await res.json();
      document.getElementById('cartCount').textContent = data.totalItem || 0;
    } catch {}
  }

  async function loadProduk() {
    try {
      const res = await fetch(`/api/produk/${productId}`);
      detail = await res.json();
      document.getElementById("produk-img").src = `/api/produk/gambar/${detail._id}`;
      document.getElementById("produk-nama").textContent = detail.nama;
      document.getElementById("produk-harga").textContent = `Rp ${detail.harga.toLocaleString("id-ID")}`;
      document.getElementById("produk-deskripsi").textContent = detail.deskripsi;
      document.getElementById("produk-kategori").textContent = detail.kategori;

      // Badge stok
      let stokTotal = Object.values(detail.stok||{}).reduce((a,b)=>a+Number(b),0);
      const badge = document.getElementById("badge-stok");
      badge.className = "prod-badge " + (stokTotal<1 ? "habis":"stok");
      badge.textContent = stokTotal<1 ? "Stok Habis" : (stokTotal<5 ? "Stok Hampir Habis" : "Ready Stock");

      // Generate opsi ukuran
      const ukuranSelect = document.getElementById("select-ukuran");
      ukuranSelect.innerHTML = `<option value="" disabled selected>Pilih Ukuran</option>`;
      for (const uk in detail.stok) {
        const sisa = detail.stok[uk];
        const opt = document.createElement("option");
        opt.value = uk;
        opt.textContent = `${uk.toUpperCase()} ${sisa<1?"(Habis)":`(Stok: ${sisa})`}`;
        if (sisa<1) opt.disabled = true;
        ukuranSelect.appendChild(opt);
      }

      // Rekomendasi
      const semua = await fetch(`/api/produk`);
      const list = await semua.json();
      const rekom = list.filter(p=>p.kategori===detail.kategori&&p._id!==detail._id).slice(0,4);
      const container = document.getElementById("rekomendasi");
      rekom.forEach(p=>{
        const col = document.createElement("div");
        col.className="col-6 col-md-3";
        col.innerHTML=`
          <div class="card h-100">
            <img src="/api/produk/gambar/${p._id}" class="card-img-top" alt="${p.nama}">
            <div class="card-body text-center">
              <h5 class="card-title">${p.nama}</h5>
              <p class="card-text mb-2">Rp ${p.harga.toLocaleString("id-ID")}</p>
              <a href="detailproduk.html?id=${p._id}" class="btn btn-sm">Lihat Detail</a>
            </div>
          </div>`;
        container.appendChild(col);
      });
    } catch {
      showToast("Gagal memuat produk.", "error");
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
