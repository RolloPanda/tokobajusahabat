<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Keranjang Belanja - Toko Baju Sahabat</title>
  <link rel="icon" href="assets/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { font-family: system-ui, sans-serif; background: #f8f9fa; min-height: 100vh;}

    /* ===== Navbar (seragam gamis.html) ===== */
    .navbar-brand { color: #8B004B !important; letter-spacing:.5px; }
    .navbar { box-shadow: 0 2px 10px 0 rgba(139,0,75,.05);}
    .navbar .dropdown-menu {
      border-radius: 0.7em; box-shadow: 0 6px 32px #8b004b20; border: 1.5px solid #8b004b0d;
      min-width: 210px; padding: .7em 0; margin-top: 0.6em; transition: box-shadow .13s;
    }
    .navbar .dropdown-menu .dropdown-item {
      padding: .53em 1.3em; transition: background .15s, color .15s; font-size: 1.05em; border-radius: 8px;
    }
    .navbar .dropdown-menu .dropdown-item:hover,
    .navbar .dropdown-menu .dropdown-item:focus {
      background: linear-gradient(90deg, #ffd1eb2a 0%, #8B004B11 100%);
      color: #8B004B; font-weight: 500; box-shadow: 0 2px 7px #8B004B0c;
    }
    .dropdown-divider { border-color:#eee; margin:.3em 0; }
    .dropdown-submenu { position:relative; }
    .dropdown-submenu > .dropdown-menu {
      left: 100%; top: 0; margin-top: -1px; border-radius: 0.7em; box-shadow: 0 6px 32px #8b004b1c;
      border: 1.5px solid #8b004b0d; min-width: 185px; display: none; position: absolute;
    }

    @media (min-width: 992px) {
      .navbar .dropdown:hover > .dropdown-menu { display: block; margin-top: 0; animation: navDrop .17s; }
      .dropdown-submenu:hover > .dropdown-menu { display: block; left: 100%; top: 0; margin-top: -1px; }
    }
    @keyframes navDrop { from { opacity: 0; transform: translateY(13px);} to { opacity: 1; transform: none;} }

    @media (max-width:991.98px){
      .navbar .dropdown-menu { position: static !important; box-shadow: none; border-radius: 0.7em; margin-top: .6em; }
      .dropdown-submenu > .dropdown-menu { position: static !important; margin: .25rem 0 .5rem 1.2rem; box-shadow: none; border: none; background: #fff; min-width: unset; display: none; }
      .dropdown-submenu.show > .dropdown-menu { display: block !important; }

      .navbar .collapse .d-flex { flex-wrap:wrap; gap:.5rem; }
      .navbar .collapse form { width:100%; order:-1; margin-bottom:.25rem; }
      .navbar .collapse form .form-control { width:100%; }
      .navbar .collapse a.btn, .navbar .collapse button.btn { flex:1 1 auto; min-width:44%; }
    }
    @media (max-width:600px){
      .navbar .dropdown-menu { min-width: 95vw; }
      .navbar-brand { font-size: 1.12em; }
      .navbar .collapse a.btn, .navbar .collapse button.btn { min-width:48%; }
    }

    /* ===== Halaman Keranjang ===== */
    header { background: linear-gradient(90deg, #8B004B, #ad1457); color: white; padding: 38px 0 26px 0; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.11);}
    header h1 { font-size: 2rem; font-weight: bold; margin-bottom: 0.3rem; letter-spacing: .5px;}
    .section-title { text-align: center; font-weight: bold; margin-top: 2.5rem; margin-bottom: 1.5rem; color: #8B004B; letter-spacing: .5px; font-size: 1.35rem;}
    .btn-primary { background-color: #8B004B; border-color: #8B004B; }
    .btn-primary:hover { background-color: #6a0037; border-color: #6a0037; }
    table { font-size: 1rem; }
    .table-responsive { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 8px; background: #fff; padding: 1rem; margin-bottom: 2.5rem;}
    .produk-img-mini { width: 52px; height: 52px; object-fit: cover; border-radius: 7px; margin-right: .7em; border: 1px solid #eee;}
    @media (max-width:600px){ table { font-size: .93em;} }
    #toast-container { position: fixed; top: 52%; left: 50%; transform: translate(-50%,-50%); z-index: 3000; max-width: 94vw; pointer-events: none; display: flex; flex-direction: column; align-items: center;}
    .toko-toast { min-width: 220px; max-width: 340px; color: #fff; background: linear-gradient(90deg,#8B004B,#ad1457); border-radius: 13px; padding: 1rem 1.25rem; margin-bottom: 13px; box-shadow: 0 4px 22px #8B004B11; display: flex; align-items: center; font-weight: 500; font-size: 1.04rem; opacity: 0; transform: translateY(35px) scale(0.95); animation: slideInCenter .48s forwards; gap: 0.7rem; pointer-events: auto;}
    .toko-toast.toko-toast-error { background: linear-gradient(90deg,#C62828,#FF5252); }
    .toko-toast.toko-toast-info { background: linear-gradient(90deg,#1976D2,#64B5F6); }
    @keyframes slideInCenter { to { opacity: 1; transform: none;} }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Toko Baju Sahabat</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Beranda</a></li>
          <li class="nav-item"><a class="nav-link" href="#">Tentang</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="dropdownToko" role="button" data-bs-toggle="dropdown" aria-expanded="false">Toko</a>
            <ul class="dropdown-menu" aria-labelledby="dropdownToko">
              <li><a class="dropdown-item" href="penjualansemua.html">Semua Produk</a></li>
              <li><a class="dropdown-item" href="barangpopuler.html">Barang Populer</a></li>
              <li><a class="dropdown-item" href="barangbaru.html">Barang Baru</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li class="dropdown-submenu position-relative">
                <a class="dropdown-item d-flex align-items-center justify-content-between"
                   href="bajuwanita.html" aria-expanded="false">
                  Baju Wanita
                  <button class="btn btn-sm p-0 border-0 bg-transparent ms-2 submenu-toggle" type="button" aria-label="Buka submenu">
                    <i class="bi bi-caret-down-fill" aria-hidden="true"></i>
                  </button>
                </a>
                <ul class="dropdown-menu" aria-label="Submenu Baju Wanita">
                  <li><a class="dropdown-item" href="dress.html">Dress</a></li>
                  <li><a class="dropdown-item" href="blouse.html">Blouse</a></li>
                  <li><a class="dropdown-item" href="tunik.html">Tunik</a></li>
                  <li><a class="dropdown-item" href="gamis.html">Gamis</a></li>
                  <li><a class="dropdown-item" href="rokcelana.html">Rok/Celana</a></li>
                </ul>
              </li>
              <li><a class="dropdown-item" href="bajupria.html">Baju Pria</a></li>
              <li><a class="dropdown-item" href="bajuanak.html">Baju Anak</a></li>
              <li><a class="dropdown-item" href="busanamuslim.html">Busana Muslim</a></li>
            </ul>
          </li>
        </ul>
        <div class="d-flex align-items-center" style="gap: 0.5rem;">
          <form class="d-flex" action="hasilpencarian.html" method="GET">
            <input class="form-control form-control-sm me-2" type="search" name="q" placeholder="Cari Produk" required />
            <button class="btn btn-outline-success btn-sm" type="submit">Cari</button>
          </form>
          <a id="loginButton" href="login.html" class="btn btn-outline-primary btn-sm">Login</a>
          <a id="registerButton" href="daftarakun.html" class="btn btn-outline-secondary btn-sm">Buat Akun</a>
          <a id="manageAccountButton" href="akun.html" class="btn btn-outline-success btn-sm" style="display:none;">Kelola Akun</a>
          <a id="statusButton" href="statuspesanan.html" class="btn btn-outline-info btn-sm" style="display:none;">Status Pesanan</a>
          <a id="cartButton" href="keranjangbelanja.html" class="btn btn-outline-warning btn-sm position-relative" style="display:none;">
            <i class="bi bi-cart" style="font-size: 1.2rem;"></i>
            <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
          </a>
          <button id="logoutButton" class="btn btn-outline-danger btn-sm" style="display:none;">Logout</button>
        </div>
      </div>
    </div>
  </nav>
  <header>
    <div class="container">
      <h1>Keranjang Belanja</h1>
      <p class="lead mb-0">Review produk yang akan Anda beli</p>
    </div>
  </header>

  <section class="py-5">
    <div class="container">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr>
              <th>Produk</th>
              <th>Ukuran</th>
              <th style="width: 120px;">Jumlah</th>
              <th style="width: 120px;">Harga</th>
              <th style="width: 120px;">Subtotal</th>
              <th style="width: 100px;">Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="d-flex flex-column align-items-end mt-4">
          <div class="mb-3 text-end">
            <h5>Total Harga: <span id="total-harga">Rp 0</span></h5>
          </div>
          <button id="checkoutBtn" class="btn btn-primary btn-lg">Lanjutkan ke Checkout</button>
        </div>
      </div>
    </div>
  </section>

  <div id="toast-container"></div>

  <script>
    function showToast(msg, type = "success") {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toko-toast toko-toast-' + type;
      let icon = `<i class="bi bi-check-circle-fill"></i>`;
      if (type === "error") icon = `<i class="bi bi-x-circle-fill"></i>`;
      if (type === "info")  icon = `<i class="bi bi-info-circle-fill"></i>`;
      toast.innerHTML = icon + `<span style="flex:1;">${msg}</span>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = 0;
        toast.style.transform = "translateY(30px) scale(0.95)";
        setTimeout(() => toast.remove(), 400);
      }, 1800);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const email = localStorage.getItem('email');
      const name  = localStorage.getItem('name');

      // Atur tombol auth
      ['loginButton','registerButton','manageAccountButton','statusButton','cartButton','logoutButton']
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.style.display = 'none';
        });

      if (!email || !name) {
        alert("Silakan login untuk melihat keranjang.");
        return window.location.href = "login.html";
      }
      ['logoutButton','manageAccountButton','statusButton','cartButton']
        .forEach(id => document.getElementById(id).style.display = 'inline-block');
      updateCartCount(email);

      document.getElementById('logoutButton').addEventListener('click', () => {
        localStorage.clear();
        location.reload();
      });

      function formatRupiah(angka) {
        return `Rp ${angka.toLocaleString('id-ID')}`;
      }

      function hitungTotal() {
        let total = 0;
        document.querySelectorAll('tbody tr').forEach(row => {
          const harga = +row.dataset.harga;
          let jumlah = +row.querySelector('.jumlah-input').value || 1;
          if (jumlah < 1) jumlah = 1;
          const subtotal = harga * jumlah;
          row.querySelector('.subtotal').textContent = formatRupiah(subtotal);
          total += subtotal;
        });
        document.getElementById('total-harga').textContent = formatRupiah(total);
      }

      async function updateCartCount(email) {
        try {
          const res = await fetch(`/api/keranjang/jumlah/${email}`);
          const data = await res.json();
          document.getElementById('cartCount').textContent = data.totalItem || 0;
        } catch {}
      }

      async function updateJumlah(produkId, ukuran, jumlahBaru) {
        try {
          await fetch(`/api/keranjang/update/${email}/${produkId}/${encodeURIComponent(ukuran||"")}`, {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ jumlah: jumlahBaru })
          });
          updateCartCount(email);
        } catch {
          showToast('Update gagal!', 'error');
        }
      }

      async function hapusProduk(produkId, ukuran) {
        try {
          const url = `/api/keranjang/hapus/${email}/${produkId}/${encodeURIComponent(ukuran||"")}`;
          await fetch(url, { method: 'DELETE' });
          updateCartCount(email);
          location.reload();
        } catch {
          showToast('Gagal hapus produk.', 'error');
        }
      }

      async function tambahProduk(produkId, ukuran, jumlah, nama, harga) {
        try {
          const body = { _id: produkId, nama, harga, jumlah, ukuran };
          const res = await fetch('/api/keranjang/tambah', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ email, produk: body })
          });
          const j = await res.json();
          if (!j.success) showToast(j.message||'Gagal menambah.', 'error');
        } catch {
          showToast('Gagal menambah produk.', 'error');
        }
      }

      async function loadKeranjang() {
        try {
          const r = await fetch(`/api/keranjang/${email}`);
          const items = await r.json();
          const tbody = document.querySelector('tbody');
          tbody.innerHTML = '';
          if (!items.length) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center">Keranjang kosong.</td></tr>`;
            return;
          }
          for (const item of items) {
            const sub = item.harga * item.jumlah;
            const prodRes = await fetch(`/api/produk/${item.produkId}`);
            const prod = await prodRes.json();
            const sizes = Object.keys(prod.stok||{});
            const selSize = sizes.includes(item.ukuran) ? item.ukuran : (sizes[0]||'');
            let drop = `<select class="form-select form-select-sm ukuran-select" data-id="${item.produkId}" style="min-width:70px;">`;
            if (!sizes.length) {
              drop += `<option value="" selected>--</option>`;
            } else {
              for (const uk of sizes) {
                drop += `<option value="${uk}"${uk===selSize?' selected':''}>${uk.toUpperCase()}</option>`;
              }
            }
            drop += `</select>`;

            const row = document.createElement('tr');
            row.dataset.harga = item.harga;
            row.dataset.produkId = item.produkId;
            row.dataset.berat = item.berat||0;
            row.dataset.ukuran = selSize;
            row.innerHTML = `
              <td>
                <a href="detailproduk.html?id=${item.produkId}" class="text-decoration-none text-dark fw-bold">
                  <img class="produk-img-mini" src="/api/produk/gambar/${item.produkId}" alt="${item.nama}" />
                  ${item.nama}
                </a>
              </td>
              <td>${drop}</td>
              <td>
                <input type="number" class="form-control jumlah-input" value="${item.jumlah}" min="1"
                       data-id="${item.produkId}" data-ukuran="${selSize}" />
              </td>
              <td>${formatRupiah(item.harga)}</td>
              <td class="subtotal">${formatRupiah(sub)}</td>
              <td>
                <button class="btn btn-danger btn-sm btn-hapus"
                        data-id="${item.produkId}"
                        data-ukuran="${selSize}">
                  Hapus
                </button>
              </td>
            `;
            tbody.appendChild(row);
          }

          hitungTotal();

          // Dropdown ukuran
          document.querySelectorAll('.ukuran-select').forEach(sel => {
            sel.addEventListener('change', async () => {
              const tr = sel.closest('tr');
              const produkId = tr.dataset.produkId;
              const oldUkuran = tr.dataset.ukuran;
              const newUkuran = sel.value;
              const jumlah = parseInt(tr.querySelector('.jumlah-input').value) || 1;
              const nama = tr.querySelector('a').textContent.trim();
              const harga = +tr.dataset.harga;

              await fetch(`/api/keranjang/hapus/${email}/${produkId}/${encodeURIComponent(oldUkuran)}`, { method: 'DELETE' });
              await tambahProduk(produkId, newUkuran, jumlah, nama, harga);
              location.reload();
            });
          });

          document.querySelectorAll('.jumlah-input').forEach(inp => {
            inp.addEventListener('change', async () => {
              let v = parseInt(inp.value);
              if (isNaN(v)||v<1) { v=1; inp.value=1; }
              const pId = inp.dataset.id;
              const tr  = inp.closest('tr');
              const u   = tr.dataset.ukuran;
              await updateJumlah(pId, u, v);
              hitungTotal();
            });
          });

          document.querySelectorAll('.btn-hapus').forEach(btn => {
            btn.addEventListener('click', async () => {
              if (!confirm('Hapus produk dari keranjang?')) return;
              await hapusProduk(btn.dataset.id, btn.dataset.ukuran);
            });
          });

        } catch {
          showToast('Gagal load keranjang.', 'error');
        }
      }

      document.getElementById('checkoutBtn').addEventListener('click', () => {
        const cartArr = [];
        document.querySelectorAll('tbody tr').forEach(row => {
          const nama = row.querySelector('a').textContent.trim();
          const jumlah = +row.querySelector('.jumlah-input').value || 1;
          const harga = +row.dataset.harga;
          const produkId = row.dataset.produkId;
          const berat = +row.dataset.berat || 0;
          const ukuran = row.dataset.ukuran;
          cartArr.push({ produkId, nama, jumlah, harga, berat, ukuran });
        });
        localStorage.setItem('cart', JSON.stringify(cartArr));
        window.location.href = 'halamancheckout.html';
      });

      await loadKeranjang();

      // ===== Navbar mobile caret toggle =====
      document.querySelectorAll('.submenu-toggle').forEach(btn => {
        btn.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();
          const parent = btn.closest('.dropdown-submenu');
          parent.classList.toggle('show');
          const submenu = parent.querySelector('.dropdown-menu');
          submenu.classList.toggle('show');
        });
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
